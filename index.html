<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Born of Many Places</title>

    <style>
      /* -------------------------------------------------------------
       GLOBAL STYLE â€” SCRAPBOOK THEME
    ------------------------------------------------------------- */
      @import url("https://fonts.googleapis.com/css2?family=Playwrite+CZ:wght@100..400&display=swap");
      @import url("https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&family=Nunito:ital,wght@0,200..1000;1,200..1000&family=Playwrite+CZ:wght@100..400&display=swap");
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: "Nunito", sans-serif;
      }

      body {
        background: #f7efe7;
        height: 100vh;
        overflow: hidden;
        display: flex;
        justify-content: center;
        align-items: stretch;
        font-family: "Nunito", sans-serif;
      }

      /* ---------------------------------------------------------
   START SCREEN (fullscreen overlay)
--------------------------------------------------------- */

      #start-screen {
        position: fixed;
        inset: 0;
        background: #f7efe7 url("backgrounds/photobook.png") no-repeat;
        background-size: 120%;
        background-position: center;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999; /* above everything */
        /* cozy vintage treatment */
        background-color: rgba(
          249,
          241,
          232,
          0.86
        ); /* warm paper tint over the photo */
        background-blend-mode: overlay;
        padding: 28px;
        border: 1px solid rgba(110, 85, 65, 0.1);
        box-shadow: 0 20px 40px rgba(60, 40, 30, 0.36),
          inset 0 1px 0 rgba(255, 255, 255, 0.06); /* soft depth + paper sheen */
        -webkit-font-smoothing: antialiased;
        backdrop-filter: blur(3px) saturate(1.05);
        transition: opacity 0.45s ease,
          transform 0.45s cubic-bezier(0.2, 0.9, 0.2, 1);
        transform: translateY(8px);
        will-change: opacity, transform;
      }

      #start-inner {
        padding: 10px 60px;
        border-radius: 100px;
        text-align: center;
        margin-top: -60px; /* move up */
      }

      #start-inner h1 {
        font-size: 3rem;
        color: #956c52;
        margin-bottom: 20px;
        margin-left: 50px;
        line-height: 1.5;
        font-family: "Playwrite CZ", cursive;
      }

      #start-inner p {
        font-size: 1rem;
        color: #826755;
        width: 500px;
        text-align: center;
        padding-top: 10px;
        margin-bottom: 30px;
        margin-left: 45px;
      }

      #start-btn {
        font-size: 1.2rem;
        padding-top: 12px;
        padding-bottom: 12px;
        border-radius: 999px;
        margin-left: 45px;
        border: none;
        background: #7f9d86;
        color: #fffaf5;
        cursor: pointer;
        transition: 0.2s;
      }

      #start-btn:hover {
        background: #6f8c77;
        transform: translateY(-2px);
      }

      #floating-words {
        position: absolute;
        inset: 0;
        pointer-events: none;
        overflow: hidden;
        z-index: -1;
      }

      .restart-btn {
        margin-top: 20px;
        padding: 12px 30px !important;
        font-size: 1rem;
        border-radius: 999px !important;
        background: #f6f1ed !important;
        border: 2px solid rgba(120, 95, 80, 0.3) !important;
        color: #6b5343 !important;
        cursor: pointer;
        box-shadow: 1px 2px 4px rgba(70, 55, 40, 0.15) !important;
        transition: transform 0.12s ease, box-shadow 0.12s ease;
      }

      .restart-btn:hover {
        transform: translateY(-2px);
        box-shadow: 2px 3px 6px rgba(60, 45, 35, 0.25) !important;
      }

      .restart-btn:active {
        transform: translateY(1px);
        box-shadow: 0 1px 2px rgba(60, 45, 35, 0.15) !important;
      }

      /* ---------------------------------------------------------
   NARRATIVE SCREEN BETWEEN LEVELS
--------------------------------------------------------- */

      #narrative-screen {
        position: fixed;
        inset: 0;
        background: rgba(39, 38, 37, 0.96);
        backdrop-filter: blur(4px);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9998; /* just under start screen, above UI */
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.5s ease;
      }

      #narrative-screen.active {
        opacity: 1;
        pointer-events: auto;
      }

      #narrative-inner {
        padding: 60px 80px;
        border-radius: 22px;
        text-align: center;
        height: auto;
      }

      #narrative-text {
        font-size: 1.4rem;
        color: #f2efe3;
        margin-bottom: 40px;
        line-height: 1.5;
      }

      #narrative-btn {
        padding: 12px 30px;
        font-size: 1rem;
        border-radius: 999px;
        border: none;
        background: #946c3b;
        color: #fff;
        cursor: pointer;
        transition: transform 0.15s ease, background 0.15s ease;
      }

      #narrative-btn:hover {
        transform: translateY(-2px);
        background: #7b5235;
      }

      /* ---------------------------------------------------------
   MENU SCREEN (after start screen)
--------------------------------------------------------- */
      #menu-screen {
        position: fixed;
        inset: 0;
        background: #f7efe7 url("backgrounds/photobook-open.png") no-repeat
          center;
        background-size: 130%;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9998;
        opacity: 0;
        pointer-events: none;
        /* cozy vintage treatment */
        background-color: rgba(
          249,
          241,
          232,
          0.86
        ); /* warm paper tint over the photo */
        background-blend-mode: overlay;
        padding: 28px;
        border: 1px solid rgba(110, 85, 65, 0.1);
        box-shadow: 0 20px 40px rgba(60, 40, 30, 0.36),
          inset 0 1px 0 rgba(255, 255, 255, 0.06); /* soft depth + paper sheen */
        -webkit-font-smoothing: antialiased;
        backdrop-filter: blur(3px) saturate(1.05);
        transition: opacity 0.45s ease,
          transform 0.45s cubic-bezier(0.2, 0.9, 0.2, 1);
        transform: translateY(8px);
        will-change: opacity, transform;
      }

      #menu-screen.active {
        opacity: 1;
        pointer-events: auto;
      }

      #menu-inner {
        text-align: center;
        margin-bottom: 40px;
        padding-bottom: 40px;
      }

      #menu-inner h2 {
        font-size: 2.6rem;
        color: #956c52;
        margin-bottom: 30px;
        font-family: "Playwrite CZ", cursive;
      }

      #menu-levels {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
        justify-content: center;
        width: 900px;
      }

      .menu-thumb {
        width: 180px;
        height: 120px;
        border-radius: 16px;
        background-size: cover;
        background-position: center;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .menu-thumb:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
        border: #fffaf2 2px solid;
      }

      .menu-thumb.locked::after {
        content: "ðŸ”’";
        font-size: 2rem;
        position: absolute;
        inset: 0;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      /* -------------------------------------------------------------
       TREE BACKGROUND LAYER
    ------------------------------------------------------------- */

      #tree-bg {
        position: fixed;
        inset: 0;
        background-size: contain;
        background-position: center;
        background-repeat: no-repeat;
        z-index: 0;
        opacity: 0.9;
        background-size: 1600px auto; /* fixed width */
        background-position: center left;
      }

      /* soft vignette */
      #tree-bg::after {
        content: "";
        position: absolute;
        inset: 0;
        background: radial-gradient(
          circle at center,
          transparent 40%,
          rgba(0, 0, 0, 0.18) 100%
        );
        pointer-events: none;
      }

      /* slight paper texture overlay */
      #paper-grain {
        position: fixed;
        inset: 0;
        background-image: url("backgrounds/paper_texture.png");
        background-size: 600px;
        opacity: 0.25;
        mix-blend-mode: multiply;
        z-index: 1;
        pointer-events: none;
      }

      /* -------------------------------------------------------------
       UI LAYER (HEADER + LEFT PANEL + FOOTER)
    ------------------------------------------------------------- */

      #ui {
        position: relative;
        z-index: 10;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        overflow: hidden; /* prevent weird overflow */
      }

      header {
        background: rgba(255, 255, 255, 0.85);
        padding: 16px 22px;
        border-bottom: 1px solid rgba(120, 95, 80, 0.25);
        backdrop-filter: blur(4px);
      }

      header h1 {
        font-size: 1.5rem;
        color: #6b4e3c;
        font-weight: 700;
      }

      header p {
        font-size: 0.9rem;
        color: #9c7d68;
        margin-top: 3px;
      }

      main {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 12px 18px;

        overflow-y: auto; /* <â€” THIS makes the UI safe */
        overscroll-behavior: contain;
        min-height: 0; /* required for nested flex scrolling */
      }

      #board {
        flex: 1;
        display: flex;
        gap: 16px;
        min-height: 0;
      }

      /* -------------------------------------------------------------
       LEFT PANEL â€” DRAGGABLE ITEMS
    ------------------------------------------------------------- */

      #left-panel {
        width: 180px;
        min-width: 150px;
        background: rgba(255, 252, 248, 0.6);
        border-radius: 18px;
        border: #654c3d8d 2px dashed;
        display: flex;
        flex-direction: column;

        overflow-y: auto; /* panel scrolls */
        max-height: 100%; /* never pushes other UI */
      }

      #left-panel-title {
        font-size: 0.8rem;
        font-weight: 800;
        color: #826755;
        margin-bottom: 8px;
        padding-top: 10px;
        text-align: center;
      }

      #panel-toggle {
        width: 100%;
        padding: 12px 15px;
        font-size: 0.8rem;
        font-weight: 600;
        font-family: "Nunito", sans-serif;
        background: rgba(255, 255, 255, 0.7);
        border-radius: 10px;
        border-bottom-left-radius: 0px;
        border-bottom-right-radius: 0px;
        border: 0px;
        cursor: pointer;
        margin-bottom: 6px;
        color: #6b4e3c;
        backdrop-filter: blur(4px);
        transition: background 0.15s ease;
        text-align: left;
      }

      #panel-toggle:hover {
        background: rgba(255, 255, 255, 0.9);
      }

      /* PANEL CLOSED STATE */
      /* CLOSED STATE -------------------------------------------------- */

      #left-panel.closed {
        width: 50px !important;
        min-width: 50px !important;

        /* Remove background & border */
        background: transparent !important;
        border: none !important;
        border-radius: 0 !important;

        /* SHRINK TO FIT THE TOGGLE BUTTON */
        height: auto !important;
        max-height: none !important;
        padding: 5 !important;

        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0;
        overflow: visible !important;
      }

      /* Hide draggables + title in closed mode */
      #left-panel.closed #draggables,
      #left-panel.closed #left-panel-title {
        display: none !important;
      }

      /* Toggle button stays visible and centered */
      #left-panel.closed #panel-toggle {
        width: 42px;
        border-radius: 12px;
        margin: 6px auto;
        text-align: center;
        font-size: 0.75rem;
        padding: 6px 4px;
      }

      /* -------------------------------------------------------------
   DRAGGABLE ITEMS â€” FIXED SIZES
------------------------------------------------------------- */

      #draggables {
        padding: 10px;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(55px, 1fr));
        gap: 7px;
        position: relative;
        z-index: 10; /* Above dropzones */
        pointer-events: auto;
        min-height: 100%;
        flex: 1;
        min-height: 0; /* prevents flex overflow */
        overflow-y: auto;
      }

      .draggable {
        width: 100%;
        cursor: grab;
        transition: transform 0.15s ease, filter 0.15s ease;
        display: flex;
        justify-content: center;
      }

      .draggable img {
        width: 100px; /* small in panel */
        height: fit-content;
        pointer-events: none; /* required! */
        filter: drop-shadow(0 2px 3px rgba(0, 0, 0, 0.25));
      }

      .draggable:hover {
        transform: rotate(-2deg) scale(1.08);
      }

      /* When placed on the board */
      .on-board img {
        width: 90px; /* medium on board */
        height: auto;
        filter: drop-shadow(0 3px 4px rgba(0, 0, 0, 0.2));
      }

      .on-board:hover {
        transform: scale(1.03);
      }

      .level5-zone .draggable img {
        width: 420px !important;
        height: auto !important;
        max-width: 0px;
        max-height: 200px;
        object-fit: contain;
        transition: transform 0.2s ease;
      }

      .level5-zone .draggable:hover img {
        transform: scale(1.05);
      }

      /* When an item is dropped into dzPuppet */
      .in-puppet-zone img {
        width: 420px !important; /* match size of dzPuppet */
        max-width: 100% !important;
        height: auto !important;
        object-fit: contain;
        transition: transform 0.25s ease;
      }

      /* Larger draggables in the panel */
      .panel-large .draggable img {
        width: 120px !important; /* make them bigger */
        height: auto !important;
      }

      /* -------------------------------------------------------------
       DROPZONES
    ------------------------------------------------------------- */

      #dropzones {
        position: fixed;
        inset: 0;
        z-index: 20;
        pointer-events: none;
      }

      .dropzone {
        position: absolute;
        min-width: 60px;
        min-height: 300px;
        /*border: 2px dashed rgba(80, 60, 40, 0.03);*/
        border-radius: 10px;
        background: rgba(255, 250, 245, 0.1);
        pointer-events: auto;
        transition: background 0.15s ease, transform 0.15s ease;
        z-index: 21;
      }

      /* Special horizontal-growing dropzone for Level 1 */
      #dropzones .dropzone.horizontal-grow {
        display: flex;
        flex-direction: row;
        align-items: flex-start;
        min-width: 600px;
        min-height: 370px;
        height: auto;
        padding: 10px;

        width: auto; /* grow horizontally */
        max-width: none;
        white-space: nowrap;

        overflow-x: visible;
        overflow-y: visible;
      }

      .dropzone.dropzone.horizontal-grow .draggable {
        width: auto;
      }

      .dropzone.dropping {
        background: rgba(255, 250, 240, 0.2);
        transform: scale(1.05);
      }

      /* Only Level 2 dropzones align items to bottom */
      .dropzone.bottom-align {
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        align-items: center;
        width: 260px;
      }

      .level3-zone {
        width: 1000px !important;
        height: 20px !important;
        background: rgba(255, 255, 255, 0.15);
        border-radius: 12px;
        display: flex;
        align-items: flex-end;
      }

      /* Make level 3 items bigger when placed on the tree */
      .level3-zone .draggable img {
        max-width: 300px;
        max-height: 300px;
        width: auto;
        height: auto;
        object-fit: contain;
      }

      .level4-zone {
        width: 540px !important;
        min-height: 50px !important;
        max-height: 70px !important;
        border-radius: 12px;
        display: flex;
        align-items: flex-start;
        background: rgba(246, 246, 246, 0.34);
      }

      /* Level 5 dropzones */
      .level5-doll {
        width: 300px !important;
        min-height: 300px !important;
        border-radius: 14px;
      }

      .level5-closet {
        width: 300px !important;
        min-height: 600px !important;
        border-radius: 14px;
        display: flex;
        flex-direction: column; /* or row depending on layout */
        gap: 50px; /* adjust spacing here */
        align-items: center;
      }

      .level6-trigger-zone {
        width: 610px !important;
        height: 540px !important;
        border-radius: 3000px;
      }

      .level7-iconzone {
        width: 120px !important;
        height: 120px !important;
        min-width: 100px !important; /* â† override global */
        min-height: 100px !important; /* â† override global */
        border-radius: 24px;
        background: rgba(255, 255, 255, 0.18);
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: visible;
      }

      /* Level 8 â€” special square dropzone */
      .level8-square {
        width: 180px !important;
        height: 180px !important;
        min-width: 180px !important;
        min-height: 180px !important;
        background: rgba(230, 230, 230, 0.18);
        border-radius: 2000px;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      /* Make placed items fill the Level 8 dropzones */
      .level8-square .draggable img {
        width: 100% !important;
        height: 100% !important;
        object-fit: contain; /* prevents distortion */
      }
      /* -------------------------------------------------------------
       CONTROLS
    ------------------------------------------------------------- */

      #controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: #ffffff;
        padding-top: 8px;
      }

      #next-btn {
        background: #7f9d86;
        color: #fffaf2;
        border: none;
        padding: 9px 18px;
        border-radius: 999px;
        cursor: pointer;
        font-weight: 600;
        box-shadow: 0 4px 10px rgba(60, 85, 70, 0.25);
        transition: transform 0.1s ease, background 0.1s ease;
      }

      #next-btn:hover:not(:disabled) {
        background: #6f8a76;
        transform: translateY(-2px);
      }

      #next-btn:disabled {
        background: #c4b7a9;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
      }

      /* -------------------------------------------------------------
   HERITAGE FOOTER â€” SCRAPBOOK PASTEL STYLE
------------------------------------------------------------- */

      #heritage-footer {
        background: rgba(255, 250, 245, 0.95);
        padding: 10px 24px;
        border-top: 3px dashed rgba(140, 110, 90, 0.4);
        backdrop-filter: blur(4px);
        box-shadow: 0 -4px 14px rgba(0, 0, 0, 0.12);
      }

      /* WRAPPER */
      #heritage-bar-wrapper {
        width: 100%;
        height: 38px;
        border-radius: 99px;
        overflow: hidden;
        background: #f5e6d6;
        position: relative;
        margin-bottom: 10px;
      }

      /* MAIN BAR */
      #heritage-bar {
        height: 100%;
        display: flex;
        position: relative;
      }

      /* LEGEND */
      #heritage-legend {
        display: flex;
        gap: 10px;
        justify-content: center;
        flex-wrap: wrap;
        margin-top: 5px;
      }

      /* pastel pill legend */
      .heritage-legend-item {
        background: rgba(255, 255, 255, 0.6);
        border: 1px dashed rgba(130, 110, 90, 0.4);
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 0.8rem;
        color: #6b5343;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      /* little color icon */
      .heritage-color-box {
        width: 14px;
        height: 14px;
        border-radius: 4px;
        border: 1px solid rgba(0, 0, 0, 0.25);
      }

      .heritage-segment {
        height: 100%;
        display: block;
        transition: width 0.4s ease;
      }

      /* -------------------------------------------------------------
       FINAL SUMMARY
    ------------------------------------------------------------- */

      #summary {
        display: none;
        background: rgba(255, 255, 255, 0.9);
        padding: 20px;
        border-radius: 14px;
        margin-top: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        color: #654c3d;
      }

      /* -------------------------------------------------------------
       SAFARI IOS FIXES FOR DRAGGABLES
    ------------------------------------------------------------- */
      @media screen and (-webkit-min-device-pixel-ratio: 0) {
        #draggables {
          min-height: 0;
          min-width: 0;
          align-items: flex-start;
          grid-auto-rows: min-content;
        }

        .draggable {
          align-items: flex-start;
          min-height: 0;
          overflow: hidden;
        }

        .draggable img,
        .on-board img {
          display: block;
          width: 60px;
          height: auto;
          max-width: 100%;
          object-fit: contain;
        }

        .on-board img {
          width: 90px;
        }
      }

      #draggables.panel-large .draggable img {
        width: 140px !important;
      }

      .panel-large .draggable img {
        width: 120px !important;
        height: auto !important;
      }

      #draggables.panel-large {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      }

      .heritage-segment[data-key="global"] {
        background-image: repeating-linear-gradient(
          45deg,
          #e8d5c4 0 12px,
          /* warm beige */ #c7d9d4 12px 24px,
          /* sage pastel */ #d9cce3 24px 36px,
          /* muted lavender */ #f4e3cd 36px 48px,
          /* creamy tan */ #cfd8e8 48px 60px,
          /* soft dusty blue */ #ead6e0 60px 72px /* powdered rose */
        );
      }

      /* ----------------------------New ideas--------------------------------- */
      /* -------------------------------------------------------------
   SOFT â€¢ COZY â€¢ PASTEL â€¢ HAND-DRAWN BUTTONS (subtle version)
------------------------------------------------------------- */

      button,
      #start-btn,
      #next-btn,
      #narrative-btn {
        font-family: inherit !important;

        /* Soft pastel background */
        background: #f7f3f0 !important;
        background: linear-gradient(135deg, #f9f4f2, #f6f5fa) !important;

        /* Very soft hand-drawn border */
        border: 1.8px solid rgba(140, 110, 90, 0.35) !important;
        border-radius: 18px !important;

        /* Gentle baby-shadow, fuzzy like pencil */
        box-shadow: 1px 2px 4px rgba(90, 70, 55, 0.15) !important;

        padding: 10px 38px !important;

        color: #6a594d !important;
        cursor: pointer;

        transition: transform 0.12s ease, box-shadow 0.12s ease,
          background 0.12s ease;
      }

      /* Soft hover â€” no wobbling, only gentle lift */
      button:hover,
      #start-btn:hover,
      #narrative-btn:hover,
      #next-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        background: linear-gradient(135deg, #f6f1ef, #f4f2f9) !important;
        box-shadow: 2px 3px 6px rgba(80, 60, 45, 0.18) !important;
      }

      /* Pressed state â€” soft, cozy squash */
      button:active,
      #start-btn:active,
      #narrative-btn:active,
      #next-btn:active {
        transform: translateY(1px);
        box-shadow: 0px 1px 2px rgba(70, 55, 40, 0.18) !important;
      }

      /* Disabled â€” faint, muted, soft */
      #next-btn:disabled {
        background: #eee8e3 !important;
        border-color: rgba(150, 130, 115, 0.25) !important;
        color: #a09188 !important;
        box-shadow: none !important;
        transform: none !important;
        cursor: not-allowed !important;
      }

      /* Subtle hand-drawn outline effect */
      button::after,
      #start-btn::after,
      #narrative-btn::after,
      #next-btn::after {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: 18px;
        border: 1px solid rgba(0, 0, 0, 0.05);
        transform: translate(1.5px, 1px) rotate(0.6deg);
        pointer-events: none;
        opacity: 0.4;
      }

      /* -------------------------------------------------------------
   SOFT â€¢ COZY â€¢ PASTEL SUMMARY POPUP (Your Heritage Mix)
------------------------------------------------------------- */

      #summary {
        display: none; /* controlled by JS */
        max-width: 450px;
        margin: 40px auto;

        /* Soft pastel paper */
        background: linear-gradient(135deg, #fdf9f4 0%, #faf6f1 100%);
        border-radius: 24px;
        padding: 32px 40px;

        /* Soft hand-drawn border */
        border: 2px solid rgba(140, 110, 90, 0.25);
        box-shadow: 0 8px 20px rgba(80, 60, 45, 0.12),
          inset 0 1px 3px rgba(255, 255, 255, 0.6);

        text-align: center;
        color: #6b5445;

        /* fade-in */
        opacity: 0;
        transform: translateY(10px);
        animation: summaryFade 0.6s ease forwards;
      }

      @keyframes summaryFade {
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      #summary h2 {
        font-family: "Playwrite CZ", cursive;
        font-size: 2rem;
        color: #8a6a52;
        margin-bottom: 20px;

        /* soft glow */
        text-shadow: 1px 1px 0 rgba(255, 255, 255, 0.8);
      }

      /* List styling */
      #summary ul {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      #summary li {
        background: rgba(255, 255, 255, 0.6);
        border: 1.5px dashed rgba(120, 95, 80, 0.35);
        border-radius: 999px;
        padding: 10px 16px;

        font-size: 1.05rem;
        color: #6a564c;
        letter-spacing: 0.3px;

        display: flex;
        justify-content: space-between;

        /* hand-drawn subtle shadow */
        box-shadow: 1px 2px 4px rgba(70, 55, 40, 0.1);
      }

      /* Optional: small heritage swatch next to each item */
      #summary li::before {
        content: "";
        width: 14px;
        height: 14px;
        border-radius: 4px;
        border: 1px solid rgba(0, 0, 0, 0.15);
        margin-right: 10px;
        background: var(--heritage-color, #ddd);
      }

      /* ================================
   NARRATIVE â€” CENTERED LAYOUT
================================ */
      /* BACKDROP */
      #narrative-screen {
        position: fixed;
        inset: 0;
        backdrop-filter: blur(6px);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9998;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.4s ease;
      }

      #narrative-screen.active {
        opacity: 1;
        pointer-events: auto;
      }

      /* NARRATIVE CARD */
      #narrative-inner {
        position: relative;
        width: 600px;
        max-width: 600px;
        height: 530px; /* fixed height â†’ stable layout */
        border-radius: 24px;
        padding: 40px 40px 80px; /* space for button */
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      /* TEXT BOX â€” fixed height */
      #narrative-text-wrapper {
        flex: 1; /* take all available vertical space */
        display: flex;
        justify-content: center; /* vertical centering */
        align-items: center; /* horizontal centering */
        overflow-y: auto; /* scroll only if too long */
        text-align: center;
        padding: 0 10px;
      }

      /* Actual text */
      #narrative-text {
        font-size: 1.35rem;
        line-height: 1.55;
        color: #f5f2e8;
        max-width: 480px;
      }

      #narrative-btn {
        width: 30% !important; /* â† keeps button size natural */
        display: inline-block !important;
        padding: 12px 36px !important; /* use your preferred padding */
      }

      #narrative-buttons button {
        min-width: 160px; /* adjust to taste */
        text-align: center;
      }

      #narrative-back {
        padding: 12px 24px !important;
        opacity: 0.8;
      }

      #narrative-back:hover {
        opacity: 1;
      }

      #info-popup {
        position: fixed;
        inset: 0;
        background: rgba(20, 20, 20, 0.55);
        backdrop-filter: blur(5px);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 100000;
      }

      #info-popup.active {
        display: flex;
      }

      #info-inner {
        width: 480px;
        max-width: 90%;
        background: linear-gradient(135deg, #fdf9f4, #faf6f1);
        padding: 40px;
        border-radius: 22px;
        border: 2px solid rgba(140, 110, 90, 0.25);

        color: #6b5445;
        text-align: center;
      }

      #info-inner h2 {
        font-family: "Playwrite CZ", cursive;
        font-size: 2rem;
        margin-bottom: 16px;
        color: #8a6a52;
      }

      #info-inner ul {
        list-style: none;
        padding: 0;
        margin: 16px 0;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      #info-inner li {
        background: rgba(255, 255, 255, 0.6);
        border-radius: 999px;
        padding: 8px 14px;
        font-size: 0.95rem;
      }

      #info-close {
        margin-top: 20px;
        padding: 10px 26px !important;
      }
    </style>
  </head>
  <body>
    <!-- Start screen -->
    <div id="start-screen">
      <div id="start-inner">
        <h1>
          Born<br />
          of <br />
          Many Places
        </h1>
        <p>A game about heritage, identity, and the memories we collect.</p>
        <button id="start-btn">Open</button>
      </div>
    </div>

    <div id="narrative-screen">
      <div id="narrative-inner">
        <div id="narrative-text-wrapper">
          <p id="narrative-text"></p>
        </div>

        <div id="narrative-buttons" style="display: flex; gap: 10px">
          <button id="narrative-back">Back</button>
          <button id="narrative-next">Continue</button>
        </div>
      </div>
    </div>

    <div id="menu-screen">
      <div id="menu-inner">
        <h2>Select a Memory</h2>
        <div id="menu-levels"></div>
      </div>
    </div>

    <button
      id="mute-btn"
      style="
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        background: rgba(255, 255, 255, 0.7);
        border-radius: 50%;
        width: 48px;
        height: 48px;
        border: 2px solid rgba(120, 95, 80, 0.4);
        font-size: 1.2rem;
        display: flex;
        justify-content: center;
        align-items: center;
      "
    >
      ðŸ”Š
    </button>

    <button
      id="info-btn"
      style="
        position: fixed;
        top: 20px;
        right: 120px; /* sits left of mute */
        z-index: 9999;
        background: rgba(255, 255, 255, 0.7);
        border-radius: 50%;
        width: 48px;
        height: 48px;
        border: 2px solid rgba(120, 95, 80, 0.4);
        font-size: 1.2rem;
        display: flex;
        justify-content: center;
        align-items: center;
      "
    >
      ?
    </button>

    <audio id="bg-music" loop preload="auto">
      <source src="/assets/bg-music.mp3" type="audio/mpeg" />
    </audio>

    <audio id="pop-sound" preload="auto">
      <source src="assets/pop.mp3" type="audio/mpeg" />
    </audio>

    <audio id="shine-sound" preload="auto">
      <source src="assets/shine.mp3" type="audio/mpeg" />
    </audio>

    <audio id="click-sound" preload="auto">
      <source src="assets/click.mp3" type="audio/mpeg" />
    </audio>

    <audio id="menu-click-sound" preload="auto">
      <source src="assets/menu-click.mp3" type="audio/mpeg" />
    </audio>

    <!-- Background Layers -->
    <div id="tree-bg"></div>
    <div id="paper-grain"></div>

    <!-- UI -->
    <div id="ui">
      <!-- <header>
      <h1>Heritage Mixer</h1>
      <p>Place the memories where they feel at home.</p>
    </header> -->

      <main>
        <section id="board">
          <!-- Left Panel -->
          <div id="left-panel">
            <button id="panel-toggle">â˜° Memories</button>
            <div id="draggables"></div>
          </div>
        </section>

        <section id="controls">
          <div id="progress"></div>
          <button id="next-btn" disabled>Lock in</button>
        </section>

        <section id="summary"></section>
      </main>

      <footer id="heritage-footer">
        <div id="heritage-bar-wrapper">
          <div id="heritage-bar"></div>
        </div>

        <div id="heritage-legend"></div>
      </footer>
    </div>

    <div id="info-popup">
      <div id="info-inner">
        <h2>How to Play</h2>

        <p>
          Each scene in <strong>Born of Many Places</strong> represents a
          memory.
        </p>
        <p>
          Drag the objects from the left panel onto the scene where you feel
          they belong.
        </p>

        <ul>
          <li>Each object carries a cultural heritage.</li>
          <li>Placing objects increases heritage points.</li>
          <li>Some scenes have special rules (Feel free to experiment!).</li>
          <li>There isn't a correct answer.</li>
          <li>After finishing a scene, press <strong>Lock In</strong>.</li>
          <li>Your heritage bar at the bottom shows your blend.</li>
        </ul>

        <button id="info-close">Close</button>
      </div>
    </div>

    <!-- Dropzones Layer -->
    <div id="dropzones"></div>

    <script>
      /* === Heritage Definitions === */
      const HERITAGES = [
        { key: "hungarian", label: "Hungarian", color: "#d78f88" },
        { key: "szekely", label: "SzÃ©kely", color: "#8aa9c9" },
        { key: "italian", label: "Italian", color: "#91b497" },
        { key: "russian", label: "Russian", color: "#a892c4" },
        { key: "svab", label: "SvÃ¡b", color: "#e4c27a" },
        {
          key: "global",
          label: "Global",
          color: "#ccc",
        },
      ];

      let heritagePoints = {
        hungarian: 0,
        szekely: 0,
        italian: 0,
        russian: 0,
        svab: 0,
        global: 0,
      };

      /* === Levels === */
      const LEVELS = [
        /* ============================
       LEVEL 1  (Birth Cert)
  ============================ */
        {
          id: 1,
          background: "backgrounds/birth_cert.png",
          maxPerZone: Infinity,
          elements: [
            { id: "anna", image: "assets/anna.png", heritage: "hungarian" },
            { id: "nina", image: "assets/nina.png", heritage: "russian" },
            { id: "toro", image: "assets/toro.png", heritage: "hungarian" },
          ],
          dropzones: [{ id: "dzAnna", x: 59, y: 44 }],
        },

        /* ============================
       LEVEL 2  (VHS Shelf)
  ============================ */
        {
          id: 2,
          background: "backgrounds/shelf.png",
          maxPerZone: Infinity,
          elements: [
            { id: "e1", image: "assets/vhs-no.png", heritage: "russian" },
            { id: "e2", image: "assets/vhs-lion.png", heritage: "global" },
            { id: "e3", image: "assets/vhs-szaffi.png", heritage: "hungarian" },
            { id: "e4", image: "assets/vhs-winnie.png", heritage: "global" },
            {
              id: "e5",
              image: "assets/vhs-macskafogo.png",
              heritage: "hungarian",
            },
          ],
          dropzones: [{ id: "vhsZone", xLeft: 18, y: 32 }],
        },

        /* ============================
       LEVEL 5  (Closet + Puppet)
  ============================ */
        {
          id: 5,
          background: "backgrounds/closet.png",
          maxPerZone: 1,
          elements: [
            {
              id: "hunCloth",
              image: "assets/hungarian-folkclothing.png",
              heritage: "hungarian",
            },
            {
              id: "svabCloth",
              image: "assets/svab-folkclothing.png",
              heritage: "svab",
            },
          ],
          dropzones: [
            { id: "dzPuppet", x: 31.5, y: 56 },
            { id: "dzCloset", x: 69, y: 52 },
          ],
        },

        /* ============================
       LEVEL 3  (Christmas Tree)
  ============================ */
        {
          id: 3,
          background: "backgrounds/christmas_tree.png",
          maxPerZone: 1,
          elements: [
            {
              id: "betlehem",
              image: "assets/betlehem.png",
              heritage: "hungarian",
            },
            {
              id: "dedmoroz",
              image: "assets/dedmoroz.png",
              heritage: "russian",
            },
          ],
          dropzones: [{ id: "dzBetlehem", x: 54, y: 62 }],
        },

        /* ============================
       LEVEL 7  (Garden Icons)
  ============================ */
        {
          id: 7,
          background: "backgrounds/garden.png",
          maxPerZone: 1,
          elements: [
            { id: "panda", image: "assets/panda-icon.png", heritage: "global" },
            {
              id: "bear",
              image: "assets/bear-icon.png",
              heritage: "szekely",
            },
            {
              id: "wolt",
              image: "assets/wolt-icon.png",
              heritage: "hungarian",
            },
          ],
          dropzones: [{ id: "dzIcon", x: 58, y: 24.8 }],
        },

        /* ============================
       LEVEL 4  (Bar / Drinks)
  ============================ */
        {
          id: 4,
          background: "backgrounds/bar.png",
          maxPerZone: 1,
          elements: [
            { id: "wineBottle", image: "assets/wine.png" },
            {
              id: "glass",
              image: "assets/glass-empty.png",
              allowMultiple: true,
            },
            { id: "soda", image: "assets/soda.png" },
          ],
          dropzones: [
            { id: "dzBottle", x: 30, y: 62 },
            { id: "dzGlass", x: 50, y: 62 },
            { id: "dzSoda", x: 70, y: 62 },
          ],
        },

        /* ============================
       LEVEL 6  (Pizza Tools)
  ============================ */
        {
          id: 6,
          background: "backgrounds/pizza-on-table.png",
          maxPerZone: 1,
          elements: [
            { id: "knife", image: "assets/knife.png", heritage: "global" },
            {
              id: "pizzaCutter",
              image: "assets/pizza-cutter.png",
              heritage: "hungarian",
            },
            { id: "scissor", image: "assets/scissor.png", heritage: "italian" },
          ],
          dropzones: [{ id: "dzTrigger", x: 54, y: 42 }],
        },

        /* ============================
       LEVEL 8  (Desk + Foods)
  ============================ */
        {
          id: 8,
          background: "backgrounds/desk3.png",
          maxPerZone: 1,
          elements: [
            {
              id: "spagetti",
              image: "assets/spegetti.png",
              heritage: "italian",
            },
            {
              id: "porkolt",
              image: "assets/porkolt.png",
              heritage: "hungarian",
            },

            { id: "vineta", image: "assets/vineta.png", heritage: "szekely" },
            {
              id: "gozgomboc",
              image: "assets/gozgomboc.png",
              heritage: "svab",
            },
            {
              id: "pelmeni",
              image: "assets/pelmeni.png",
              heritage: "russian",
            },
            {
              id: "vinigret",
              image: "assets/vinigret.png",
              heritage: "russian",
            },
            { id: "mititei", image: "assets/mititei.png", heritage: "szekely" },
            { id: "gulyas", image: "assets/gulyas.png", heritage: "hungarian" },
          ],
          dropzones: [
            { id: "dzTable1", x: 51, y: 15 },
            { id: "dzTable2", x: 51, y: 72 },
            { id: "dzTable3", x: 35.5, y: 48 },
            { id: "dzTable4", x: 66.6, y: 48 },
          ],
        },
      ];

      let preMenuIndex = 0;

      /* Narratives between levels */
      const PRE_MENU = [
        "I love to have a structure, to have my things and thoughts in order. I love labeling things, categorizing them, putting them in boxes. But sometimes, life is not that simple. Sometimes, things donâ€™t fit neatly into one box.",
        "When I tried to define my identity, everything felt blurry. What is my culture? What is my heritage? Where do I belong? I canâ€™t say Iâ€™m fully Hungarian, but I also canâ€™t claim a perfect mix of two nationalities. So how do we define identity? By language? By where we live? By our blood, our memories, or something else entirely?",
        "I tried to showcase my dilemma with this cozy puzzle game. This is a game about heritage, identity, and the memories I collected along the way.",
        "Are you ready to explore it?",
      ];

      const NARRATIVE = {
        0: "I was born with two names, one from my hungarian grandmother, and one from my russian grandmother. This would indicate two heritages. Do I really belong to both? I don't even speak russian...",
        1: "But I grew up watching russian cartoons, and eating russian food. So maybe I do belong to both after all?",
        2: "I went to a german national bilingual school, where I learned about my svÃ¡b (ungarndeutsche) heritage, what came from my great-grandmother. I sang in the national choir, and learned folk dances. I tried the hungarian ones too, but hated them then. I hid my folk clothes in the back of the closet. Does it make me less hungarian?",
        3: "As I spent more and more time away from home, I grew away from my russian roots. But it stayed still with me and my family during the most special time of the year: Christmas.",
        4: "Later, I moved to Transylvania, Romania. They speak hungarian there, but their culture is different. They have their own traditions, food, and way of life. They call themselves SzÃ©kelys. I spent there two years of my life, I started speak like them, behave like them, but did I become one of them? I have never been to Russia, so am I more SzÃ©kely than Russian now?",
        5: "Moving from Hungary made me realize how much I'm hungarian after all. When I moved to Italy I experienced such differencies I took for granted back home. Once I even taught a bartender how to make a proper frÃ¶ccs!",
        6: "But if I can be more szÃ©kely than russian, it's not about blood or passport. If I pick up traditions, language, food, and memories from a place, does it make me part of that culture? Can I choose my heritage, for example be Italian? ",
        7: "After all, identity is fluid. It changes with time, place, and experience. It's not about fitting into a box, but about embracing the complexity of who we are. All these cultures, memories, and experiences make me who I am today.",
        8: "But society loves boxes, and so do I. So I choose to fit in all these boxes at once. Because I am born of many places.",
      };

      let currentLevel = 0;
      let unlockedLevels = 1;
      let placements = {};
      let zoneContents = {};

      /* -------------------------------------------------------------
                       INITIALIZERS
                    ------------------------------------------------------------- */
      function initBar() {
        const bar = document.getElementById("heritage-bar");
        const legend = document.getElementById("heritage-legend");

        bar.innerHTML = "";
        legend.innerHTML = "";

        HERITAGES.forEach((h) => {
          // segment
          const seg = document.createElement("div");
          seg.className = "heritage-segment";
          seg.dataset.key = h.key;
          if (h.key !== "global") {
            seg.style.background = h.color;
          }
          seg.style.width = "0%"; // animate from 0
          bar.appendChild(seg);

          // legend pill
          const item = document.createElement("div");
          item.className = "heritage-legend-item";
          item.innerHTML = `
                      <div class="heritage-color-box" style="background:${h.color}"></div>
                      ${h.label}
                    `;
          legend.appendChild(item);
        });

        updateBar();
      }

      function applyHeritagePointsForLevel(level) {
        // Loop through all placed items
        for (const itemId in placements) {
          const dz = placements[itemId];
          if (!dz) continue; // item not placed

          // Get the draggable element
          const el = document.querySelector(`.draggable[data-id="${itemId}"]`);
          if (!el) continue;

          const heritage = el.dataset.heritage;

          // Skip global items or items without heritage
          if (!heritage) continue;

          // Award points
          if (heritagePoints.hasOwnProperty(heritage)) {
            heritagePoints[heritage] += 1; // adjust scale if needed
          }
        }
      }

      function updateBar() {
        const bar = document.getElementById("heritage-bar");
        const legend = document.getElementById("heritage-legend");

        const total =
          Object.values(heritagePoints).reduce((a, b) => a + b, 0) || 1;

        // Filter heritage entries that actually have points
        const activeHeritages = HERITAGES.map((h) => ({
          ...h,
          value: heritagePoints[h.key],
          pct: (heritagePoints[h.key] / total) * 100,
        })).filter((h) => h.value > 0);

        // OPTIONAL: sort visually by percentage (largest â†’ smallest)
        activeHeritages.sort((a, b) => b.pct - a.pct);

        // Clear existing bar + legend
        bar.innerHTML = "";
        legend.innerHTML = "";

        // Build updated segments + legend entries
        activeHeritages.forEach((h) => {
          const seg = document.createElement("div");
          seg.className = "heritage-segment";
          seg.dataset.key = h.key;

          // color (except global which uses pattern)
          if (h.key !== "global") {
            seg.style.background = h.color;
          }

          seg.style.width = h.pct + "%";
          bar.appendChild(seg);

          // Legend pill
          const item = document.createElement("div");
          item.className = "heritage-legend-item";
          item.innerHTML = `
      <div class="heritage-color-box" style="background:${h.color}"></div>
      ${h.label}
    `;
          legend.appendChild(item);
        });
      }

      function buildMenu() {
        const wrap = document.getElementById("menu-levels");
        wrap.innerHTML = "";

        LEVELS.forEach((lvl, index) => {
          const thumb = document.createElement("div");
          thumb.className = "menu-thumb";
          thumb.style.backgroundImage = `url(${lvl.background})`;

          // LOCKED STATE
          if (index >= unlockedLevels) {
            thumb.style.filter = "grayscale(60%) brightness(60%)";
            thumb.style.cursor = "not-allowed";
            thumb.style.opacity = "0.5";
            thumb.classList.add("locked");

            // prevent clicking locked levels
            thumb.onclick = () => {};
          }
          // UNLOCKED STATE
          else {
            thumb.onclick = () => {
              playMenuClick(); // â­ NEW SOUND
              startLevelFromMenu(index);
            };
          }

          wrap.appendChild(thumb);
        });
      }

      function showMenu() {
        buildMenu();
        document.getElementById("menu-screen").classList.add("active");
      }

      function showLevelIntro(levelIndex) {
        const screen = document.getElementById("narrative-screen");
        const textEl = document.getElementById("narrative-text");
        const nextBtn = document.getElementById("narrative-next");
        const backBtn = document.getElementById("narrative-back");

        textEl.innerHTML = NARRATIVE[levelIndex] || "";
        screen.classList.add("active");

        // For level intros, BACK goes to menu
        backBtn.style.display = "inline-block";
        backBtn.onclick = () => {
          playClick();
          screen.classList.remove("active");
          showMenu();
        };

        // Change last levelâ€™s intro button to "Yes"
        nextBtn.textContent =
          levelIndex === LEVELS.length - 1 ? "Yes" : "Continue";

        nextBtn.onclick = () => {
          playClick();
          screen.classList.remove("active");
          loadLevel(levelIndex);
        };
      }

      function startLevelFromMenu(levelIndex) {
        currentLevel = levelIndex;
        document.getElementById("menu-screen").classList.remove("active");

        // â­ Show intro narrative before each level
        showLevelIntro(levelIndex);
      }

      function showPreMenuNarrative() {
        const screen = document.getElementById("narrative-screen");
        const textEl = document.getElementById("narrative-text");
        const nextBtn = document.getElementById("narrative-next");
        const backBtn = document.getElementById("narrative-back");

        textEl.innerHTML = PRE_MENU[preMenuIndex];
        screen.classList.add("active");

        // BACK BUTTON
        backBtn.style.display = preMenuIndex === 0 ? "none" : "inline-block";

        backBtn.onclick = () => {
          if (preMenuIndex > 0) {
            preMenuIndex--;
            playClick();
            showPreMenuNarrative();
          }
        };

        // NEXT BUTTON
        nextBtn.textContent =
          preMenuIndex === PRE_MENU.length - 1 ? "Yes" : "Continue";

        nextBtn.onclick = () => {
          playClick();
          preMenuIndex++;
          if (preMenuIndex < PRE_MENU.length) {
            showPreMenuNarrative();
          } else {
            screen.classList.remove("active");
            showMenu();
          }
        };
      }

      /* ============================================================
      BACKGROUND MUSIC + MUTE BUTTON
============================================================ */

      const bgMusic = document.getElementById("bg-music");
      const muteBtn = document.getElementById("mute-btn");

      let musicStarted = false;
      let isMuted = false;

      // Play music only after start button is pressed
      function startMusic() {
        if (!musicStarted) {
          bgMusic.volume = 0.4; // soft volume
          bgMusic.play().catch(() => {
            console.warn("Autoplay blocked until user interacts.");
          });
          musicStarted = true;
        }
      }

      function playShine() {
        if (isMuted) return;
        const shine = document.getElementById("shine-sound");
        shine.currentTime = 0;
        shine.play().catch(() => {});
      }

      function playClick() {
        if (isMuted) return;
        const click = document.getElementById("click-sound");
        click.currentTime = 0;
        click.play().catch(() => {});
      }
      function playMenuClick() {
        if (isMuted) return;
        const s = document.getElementById("menu-click-sound");
        s.currentTime = 0;
        s.play().catch(() => {});
      }

      // Toggle mute state
      muteBtn.addEventListener("click", () => {
        isMuted = !isMuted;

        bgMusic.muted = isMuted;
        muteBtn.textContent = isMuted ? "ðŸ”‡" : "ðŸ”Š";
      });

      const popSound = document.getElementById("pop-sound");

      function playPop() {
        if (!isMuted) {
          popSound.currentTime = 0; // restart if played rapidly
          popSound.play().catch(() => {});
        }
      }

      /* -------------------------------------------------------------
                       LOAD LEVEL
          ------------------------------------------------------------- */

      function loadLevel(i) {
        const level = LEVELS[i];
        placements = {};
        zoneContents = {};

        document.getElementById(
          "tree-bg"
        ).style.backgroundImage = `url(${level.background})`;

        document.getElementById("progress").textContent = `Scene ${i + 1}/${
          LEVELS.length
        }`;

        /* Draggables */
        const dwrap = document.getElementById("draggables");
        dwrap.innerHTML = "";

        // Make draggables larger only for levels 1, 4, 5, 6
        const panel = document.getElementById("draggables");
        panel.classList.remove("panel-large"); // reset first

        if ([1, 3, 5, 6, 7, 8].includes(level.id)) {
          panel.classList.add("panel-large");
        }

        level.elements.forEach((el) => {
          const d = document.createElement("div");
          d.className = "draggable";
          d.draggable = true;
          d.dataset.id = el.id;
          d.dataset.heritage = el.heritage;

          const img = document.createElement("img");
          img.src = el.image;

          d.appendChild(img);
          dwrap.appendChild(d);

          d.addEventListener("dragstart", dragStart);
        });

        /* Dropzones */
        const zwrap = document.getElementById("dropzones");
        zwrap.innerHTML = "";

        level.dropzones.forEach((z) => {
          const dz = document.createElement("div");
          dz.className = "dropzone";
          dz.dataset.id = z.id;
          //VHS shelf level
          if (level.id === 2) {
            dz.classList.add("horizontal-grow");
          }

          if (level.id === 3) {
            dz.classList.add("level3-zone");
          }

          if (level.id === 1) {
            dz.classList.add("level4-zone");
          }

          // LEVEL 7 â€” special icon dropzone
          if (level.id === 7) {
            if (z.id === "dzIcon") {
              dz.classList.add("level7-iconzone");
            }
          }

          // level 2 has a left-anchored dropzone (VHS shelf)
          if (level.id === 2 && z.xLeft !== undefined) {
            dz.style.left = z.xLeft + "%";
            dz.style.top = z.y + "%";
            dz.style.transform = "none"; // anchor to left
          } else {
            // default centered behavior for all other levels
            dz.style.left = z.x + "%";
            dz.style.top = z.y + "%";
            dz.style.transform = "translate(-50%, -50%)";
          }

          //BAR level
          if (level.id === 4) {
            dz.classList.add("bottom-align");
          }

          if (level.id === 5) {
            if (z.id === "dzCloset") {
              dz.classList.add("level5-closet"); // bigger dropzone
            }
            if (z.id === "dzPuppet") {
              dz.classList.add("level5-doll"); // smaller dropzone
            }
          }

          if (level.id === 6) {
            if (z.id === "dzTrigger") {
              dz.classList.add("level6-trigger-zone");
            }
          }

          // LEVEL 8 â€” special square dropzones
          if (level.id === 8) {
            if (
              z.id === "dzTable1" ||
              z.id === "dzTable2" ||
              z.id === "dzTable3" ||
              z.id === "dzTable4"
            ) {
              dz.classList.add("level8-square");
            }
          }

          dz.addEventListener("dragover", dragOver);
          dz.addEventListener("dragleave", dragLeave);
          dz.addEventListener("drop", dropItem);

          zwrap.appendChild(dz);
        });

        document.getElementById("next-btn").disabled = !anyZoneHasItems();
      }

      /* -------------------------------------------------------------
                       DRAG & DROP
       ------------------------------------------------------------- */

      let draggedId = null;

      function dragStart(ev) {
        draggedId = ev.target.dataset.id;
      }

      function dragOver(ev) {
        ev.preventDefault();
        this.classList.add("dropping");
      }

      function dragLeave() {
        this.classList.remove("dropping");
      }

      function insertAtPosition(container, draggedEl, event) {
        const children = [...container.querySelectorAll(".draggable")].filter(
          (c) => c !== draggedEl
        );

        if (children.length === 0) {
          container.appendChild(draggedEl);
          return;
        }

        const dropX = event.clientX;

        for (const child of children) {
          const rect = child.getBoundingClientRect();

          // If mouse is left of child â†’ insert before that child
          if (dropX < rect.left + rect.width / 2) {
            container.insertBefore(draggedEl, child);
            return;
          }
        }

        // Otherwise append at the end
        container.appendChild(draggedEl);
      }

      function zoneHas(zoneId, itemId) {
        return zoneContents[zoneId] && zoneContents[zoneId].includes(itemId);
      }

      function applyFoldedVersion(itemEl) {
        const id = itemEl.dataset.id;
        const img = itemEl.querySelector("img");
        if (!img) return;

        if (id === "hunCloth") {
          img.src = "assets/hun-cloth-folded.png";
        } else if (id === "svabCloth") {
          img.src = "assets/svab-cloth-folded.png";
        }
      }

      function applyUnfoldedVersion(itemEl) {
        const id = itemEl.dataset.id;
        const img = itemEl.querySelector("img");
        if (!img) return;

        if (id === "hunCloth") {
          img.src = "assets/hungarian-folkclothing.png";
        } else if (id === "svabCloth") {
          img.src = "assets/svab-folkclothing.png";
        }
      }

      function swapIntoZone(dzEl, newItemEl, dzid) {
        const panel = document.getElementById("draggables");

        // find the existing item
        const existingItems = zoneContents[dzid] || [];
        if (existingItems.length === 0) return false;

        const oldItemId = existingItems[0];
        const oldItemEl = document.querySelector(
          `.draggable[data-id="${oldItemId}"]`
        );
        if (!oldItemEl) return false;

        // Move old item back to panel
        panel.appendChild(oldItemEl);
        oldItemEl.classList.remove("on-board");
        playPop(); // â† ADD HERE

        // Update bookkeeping
        zoneContents[dzid] = [];
        placements[oldItemId] = null;

        // Place new item visually
        dzEl.appendChild(newItemEl);
        newItemEl.classList.add("on-board");

        // Update bookkeeping for new item
        zoneContents[dzid] = [newItemEl.dataset.id];
        placements[newItemEl.dataset.id] = dzid;

        return true;
      }

      function anyZoneHasItems() {
        return Object.values(zoneContents).some((arr) => arr && arr.length > 0);
      }

      function dropItem(ev) {
        ev.preventDefault();
        this.classList.remove("dropping");

        // --- ALWAYS clean previous zone bookkeeping ---
        const dzid = this.dataset.id;
        const level = LEVELS[currentLevel];
        // --- REBUILD zoneContents[dzid] to match what is visually there ---
        const currentChildren = [...this.querySelectorAll(".draggable")].map(
          (d) => d.dataset.id
        );
        zoneContents[dzid] = currentChildren;

        const oldZone = placements[draggedId];
        if (oldZone && oldZone !== dzid) {
          if (zoneContents[oldZone]) {
            zoneContents[oldZone] = zoneContents[oldZone].filter(
              (id) => id !== draggedId
            );
          }
        }

        const el = document.querySelector(`.draggable[data-id="${draggedId}"]`);

        // === LEVEL 2 VHS===
        if (level.id === 2) {
          insertAtPosition(this, el, ev);
          el.classList.add("on-board");
          playPop(); // â† ADD HERE
          const ordered = [...this.querySelectorAll(".draggable")].map(
            (d) => d.dataset.id
          );
          zoneContents[dzid] = ordered;
          placements = {};
          ordered.forEach((id) => (placements[id] = dzid));
          if (Object.keys(placements).length >= 1)
            document.getElementById("next-btn").disabled = !anyZoneHasItems();
          return;
        }

        // === BAR ===
        if (level.id === 4) {
          const dzid = this.dataset.id;

          // --- REBUILD zone contents BEFORE logic ---
          const existingItems = [...this.querySelectorAll(".draggable")].map(
            (d) => d.dataset.id
          );
          zoneContents[dzid] = existingItems;

          const isWine = draggedId === "wineBottle";
          const isSoda = draggedId === "soda";
          const isGlass = draggedId === "glass";

          const hasWine = zoneContents[dzid].includes("wineBottle");
          const hasSoda = zoneContents[dzid].includes("soda");
          const hasGlass = zoneContents[dzid].includes("glass");

          console.log("ZONE NOW:", zoneContents[dzid]);

          // ----------------------------------------------------
          // RULE A â€” Glass cannot enter if wine or soda already placed
          // ----------------------------------------------------
          if (isGlass && (hasWine || hasSoda)) {
            this.classList.remove("dropping");
            return;
          }

          // ----------------------------------------------------
          // RULE B â€” If GLASS is present â†’ allow wine + soda freely
          // (froccs override)
          // ----------------------------------------------------
          if (!hasGlass) {
            // normal blocking rules apply
            if (isWine && hasSoda) {
              this.classList.remove("dropping");
              return;
            }
            if (isSoda && hasWine) {
              this.classList.remove("dropping");
              return;
            }
          }

          // ----------------------------------------------------
          // PLACE ITEM
          // ----------------------------------------------------
          this.appendChild(el);
          el.classList.add("on-board");
          playPop();

          // update bookkeeping
          if (!zoneContents[dzid]) zoneContents[dzid] = [];
          zoneContents[dzid].push(draggedId);
          placements[draggedId] = dzid;

          // ----------------------------------------------------
          // RULE C â€” Froccs mixing in glass
          // ----------------------------------------------------
          if (hasGlass && (isWine || isSoda)) {
            applyGlassImageChange(dzid, draggedId);
            ejectItem(draggedId, dzid); // beverage disappears after mixing
          }

          document.getElementById("next-btn").disabled = !anyZoneHasItems();
          return;
        }

        // === LEVEL 5 ===
        if (level.id === 5) {
          const dzid = this.dataset.id;

          if (!zoneContents[dzid]) zoneContents[dzid] = [];

          const oldZone = placements[draggedId];

          /* ----------------------------------------------------------
       CASE 1: dzPuppet â€” MAX 1 ITEM + FULL SWAP
     ---------------------------------------------------------- */
          if (dzid === "dzPuppet") {
            // If puppet has 1 item â†’ always swap (panel OR other dropzone)
            if (zoneContents[dzid].length === 1) {
              const oldId = zoneContents[dzid][0];
              const oldEl = document.querySelector(
                `.draggable[data-id="${oldId}"]`
              );

              // return old Puppet item to panel
              document.getElementById("draggables").appendChild(oldEl);
              oldEl.classList.remove("on-board");
              playPop(); // â† ADD HERE
              oldEl.classList.remove("in-puppet-zone");
              applyUnfoldedVersion(oldEl);

              // bookkeeping
              zoneContents[dzid] = [];
              placements[oldId] = null;
            }

            // PLACE NEW ITEM INTO PUPPET
            this.appendChild(el);
            el.classList.add("on-board");
            playPop();
            el.classList.add("in-puppet-zone");
            applyUnfoldedVersion(el);

            zoneContents[dzid] = [draggedId];
            placements[draggedId] = dzid;

            document.getElementById("next-btn").disabled = !anyZoneHasItems();
            return;
          }

          /* ----------------------------------------------------------
       CASE 2: dzCloset â€” UNLIMITED ITEMS, NO SWAP
     ---------------------------------------------------------- */
          if (dzid === "dzCloset") {
            // PLACE NEW ITEM (no limit, no swap)
            this.appendChild(el);
            el.classList.add("on-board");
            playPop();
            el.classList.remove("in-puppet-zone");

            // FIX: always reset first, then fold (prevents long-hover bug)
            applyUnfoldedVersion(el);
            applyFoldedVersion(el);

            zoneContents[dzid].push(draggedId);
            placements[draggedId] = dzid;

            document.getElementById("next-btn").disabled = !anyZoneHasItems();
            return;
          }
        }

        // === LEVEL 6: special trigger zone ===
        if (LEVELS[currentLevel].id === 6) {
          const dzid = this.dataset.id;

          if (dzid === "dzTrigger") {
            const el = document.querySelector(
              `.draggable[data-id="${draggedId}"]`
            );

            // --- Step 1: Activate next button permanently ---
            level6Activated = true;
            document.getElementById("next-btn").disabled = false;

            // --- Step 2: Change background once triggered ---
            document.getElementById("tree-bg").style.backgroundImage =
              'url("backgrounds/pizza-cut-on-table.png")';

            // --- Step 3: Immediately eject element back to panel ---
            const panel = document.getElementById("draggables");
            panel.appendChild(el);
            el.classList.remove("on-board");
            playPop(); // â† ADD HERE

            // --- Step 4: Ensure dropzone stays empty in bookkeeping ---
            placements[draggedId] = null;
            zoneContents[dzid] = [];

            this.classList.remove("dropping");
            return; // STOP â€” trigger zone never accepts items
          }
        }

        // === LEVEL 7 â€” SWAPPABLE SINGLE SLOT ===
        if (level.id === 7) {
          const dzid = this.dataset.id;
          const el = document.querySelector(
            `.draggable[data-id="${draggedId}"]`
          );

          if (dzid === "dzIcon") {
            if (!zoneContents[dzid]) zoneContents[dzid] = [];

            const panel = document.getElementById("draggables");

            // --- SWAP IF ONE ITEM EXISTS ---
            if (zoneContents[dzid].length === 1) {
              const oldId = zoneContents[dzid][0];
              const oldEl = document.querySelector(
                `.draggable[data-id="${oldId}"]`
              );
              const oldZone = placements[oldId];

              // Send old item back where it came from
              if (oldZone && oldZone !== dzid) {
                const oldZoneEl = document.querySelector(
                  `.dropzone[data-id="${oldZone}"]`
                );
                if (oldZoneEl) {
                  oldZoneEl.appendChild(oldEl);
                  zoneContents[oldZone].push(oldId);
                } else {
                  panel.appendChild(oldEl);
                }
              } else {
                panel.appendChild(oldEl);
              }

              zoneContents[dzid] = [];
              placements[oldId] = oldZone || null;
            }

            // --- PLACE NEW ITEM ---
            this.appendChild(el);
            el.classList.add("on-board");
            playPop();

            zoneContents[dzid] = [draggedId];
            placements[draggedId] = dzid;

            // NEXT BUTTON PERMANENTLY ENABLED
            document.getElementById("next-btn").disabled = false;

            return;
          }
        }

        // === LEVEL 8 â€” Allow only one element; swap if second item is dropped ===
        if (level.id === 8) {
          const dzid = this.dataset.id;

          // Ensure array exists
          if (!zoneContents[dzid]) zoneContents[dzid] = [];

          // If zone already has an item, we swap
          if (zoneContents[dzid].length === 1) {
            const existingId = zoneContents[dzid][0];
            const existingEl = document.querySelector(
              `.draggable[data-id="${existingId}"]`
            );

            // Swap: move existing element back to original place of the dragged one
            const previousZoneId = placements[draggedId];

            if (previousZoneId && previousZoneId !== dzid) {
              const previousZone = document.querySelector(
                `.dropzone[data-id="${previousZoneId}"]`
              );
              if (previousZone) {
                previousZone.appendChild(existingEl);
                zoneContents[previousZoneId].push(existingId);
              }
            } else {
              // If dragged item came from panel â†’ send existing item to panel
              document.getElementById("draggables").appendChild(existingEl);
            }

            // Update bookkeeping
            zoneContents[dzid] = [draggedId];
            placements[existingId] = previousZoneId || null;
          } else {
            // Zone empty â†’ add normally
            zoneContents[dzid].push(draggedId);
          }

          // Place the dragged element into zone
          this.appendChild(el);
          el.classList.add("on-board");
          playPop();
          placements[draggedId] = dzid;

          document.getElementById("next-btn").disabled = !anyZoneHasItems();
          return;
        }

        if (!zoneContents[dzid]) zoneContents[dzid] = [];

        // Add element visually
        this.appendChild(el);
        el.classList.add("on-board");
        playPop();

        // Update tracking
        zoneContents[dzid].push(draggedId);
        placements[draggedId] = dzid;

        if (Object.keys(placements).length >= 1)
          document.getElementById("next-btn").disabled = !anyZoneHasItems();
      }

      /* ============================================================
                   FROCCS MAKER
                ============================================================ */
      function ejectItem(id, currentZoneId) {
        const itemEl = document.querySelector(`.draggable[data-id="${id}"]`);

        // Where it was before (panel or dropzone)
        const previousZoneId = placements[id];

        // Remove from current dropzone's contents
        zoneContents[currentZoneId] = zoneContents[currentZoneId].filter(
          (x) => x !== id
        );

        // Send back to previous dropzone
        if (previousZoneId && previousZoneId !== currentZoneId) {
          const prevZone = document.querySelector(
            `.dropzone[data-id="${previousZoneId}"]`
          );
          if (prevZone) {
            prevZone.appendChild(itemEl);
            zoneContents[previousZoneId].push(id);
            return;
          }
        }

        // Otherwise send back to panel
        document.getElementById("draggables").appendChild(itemEl);
        placements[id] = null;
      }

      function glassIsInZone(dzid) {
        return zoneContents[dzid] && zoneContents[dzid].includes("glass");
      }

      function handleGlassMovedToZone(dzid) {
        console.log("Glass moved to dropzone:", dzid);
      }

      function applyGlassImageChange(dzid, itemId) {
        const glassImg = document.querySelector(
          `.dropzone[data-id="${dzid}"] .draggable[data-id="glass"] img`
        );
        if (!glassImg) return;

        const src = glassImg.src;
        const hasWine =
          src.includes("glass-wine") || src.includes("glass-froccs");
        const hasSoda =
          src.includes("glass-soda") || src.includes("glass-froccs");

        if (itemId === "wineBottle") {
          if (hasSoda) glassImg.src = "assets/glass-froccs.png";
          else glassImg.src = "assets/glass-wine.png";
        }

        if (itemId === "soda") {
          if (hasWine) glassImg.src = "assets/glass-froccs.png";
          else glassImg.src = "assets/glass-soda.png";
        }
      }

      function getGlassState() {
        const level = LEVELS[currentLevel];
        if (!level) return null;

        // find dropzone containing the glass
        for (const dzid in zoneContents) {
          if (zoneContents[dzid].includes("glass")) {
            const glassImg = document.querySelector(
              `.dropzone[data-id="${dzid}"] .draggable[data-id="glass"] img`
            );
            if (!glassImg) return null;

            if (glassImg.src.includes("glass-froccs")) return "froccs";
            if (glassImg.src.includes("glass-soda")) return "soda";
            if (glassImg.src.includes("glass-wine")) return "wine";
            return "empty";
          }
        }
        return null; // glass never placed
      }

      /* ============================================================
                   RETURN ITEM TO DRAGGABLE PANEL
      ============================================================ */

      const draggablesPanel = document.getElementById("draggables");

      draggablesPanel.addEventListener("dragover", (ev) => {
        ev.preventDefault();
      });

      draggablesPanel.addEventListener("drop", (ev) => {
        ev.preventDefault();
        if (!draggedId) return;

        const el = document.querySelector(`.draggable[data-id="${draggedId}"]`);
        if (!el) return;

        draggablesPanel.appendChild(el);
        el.classList.remove("on-board");
        playPop(); // â† ADD HERE

        // --- NEW: unfolded when moved back to panel ---
        applyUnfoldedVersion(el);

        const oldZone = placements[draggedId];
        if (oldZone) {
          zoneContents[oldZone] = zoneContents[oldZone].filter(
            (id) => id !== draggedId
          );
        }
        placements[draggedId] = null;

        if (LEVELS[currentLevel].id !== 6) {
          document.getElementById("next-btn").disabled = !anyZoneHasItems();
        }
      });

      /* -------------------------------------------------------------
                       SHOW NARRATIVE
                    ------------------------------------------------------------- */

      function showNarrative(nextLevelIndex) {
        const screen = document.getElementById("narrative-screen");
        const textEl = document.getElementById("narrative-text");

        textEl.innerHTML = NARRATIVE[nextLevelIndex] || "";
        screen.classList.add("active");

        document.getElementById("narrative-btn").onclick = () => {
          screen.classList.remove("active");
          playClick();
          // â­ After narrative â†’ go to Menu instead of starting level
          document.getElementById("menu-screen").classList.add("active");
          buildMenu();

          // â­ DO NOT load level here â€” wait for user to click it in the menu
        };
      }

      /* -------------------------------------------------------------
                       NEXT LEVEL
      ------------------------------------------------------------- */

      document.getElementById("next-btn").onclick = () => {
        const level = LEVELS[currentLevel];
        playShine();
        // Award heritage points
        if (level.id === 4) {
          const glassState = getGlassState();
          if (glassState === "froccs") {
            heritagePoints.hungarian += 7;
          }
          updateBar();
        }

        applyHeritagePointsForLevel(level);
        updateBar();

        // Advance level index
        currentLevel++;

        // Unlock next level
        if (unlockedLevels < LEVELS.length) {
          unlockedLevels = currentLevel + 1;
        }

        // If last level, finish
        if (currentLevel >= LEVELS.length) {
          finishGame();
          return;
        }

        // â­ NO NARRATIVE HERE â€” just go back to menu
        document.getElementById("menu-screen").classList.add("active");
        buildMenu();
      };

      /* -------------------------------------------------------------
                       CLOSE ELEMENT_PANEL
      ------------------------------------------------------------- */

      const panel = document.getElementById("left-panel");
      const panelToggle = document.getElementById("panel-toggle");

      panelToggle.addEventListener("click", () => {
        const closed = panel.classList.toggle("closed");

        if (closed) {
          panelToggle.textContent = "â˜°";
        } else {
          panelToggle.textContent = "â˜° Memories";
        }
      });

      /* -------------------------------------------------------------
                       END GAME
     ------------------------------------------------------------- */

      function restartGame() {
        // Reset points
        heritagePoints = {
          hungarian: 0,
          szekely: 0,
          italian: 0,
          russian: 0,
          svab: 0,
          global: 0,
        };

        // Reset progress
        currentLevel = 0;
        unlockedLevels = 1;
        placements = {};
        zoneContents = {};
        preMenuIndex = 0;

        // Reset UI
        document.getElementById("summary").style.display = "none";

        // Reset bar
        initBar();

        // Show start screen again OR go straight to menu
        // â˜… Option A: show intro narrative again
        // showPreMenuNarrative();

        // â˜… Option B: skip intro, go straight to menu
        buildMenu();
        document.getElementById("menu-screen").classList.add("active");
      }

      function finishGame() {
        document.getElementById("draggables").innerHTML = "";
        document.getElementById("dropzones").innerHTML = "";
        document.getElementById("next-btn").style.display = "none";
        document.getElementById("left-panel").style.display = "none";

        const summary = document.getElementById("summary");
        summary.style.display = "block";

        // FIX: add total calculation
        const total =
          Object.values(heritagePoints).reduce((a, b) => a + b, 0) || 1;

        // Create sorted heritage list
        const sortedHeritages = HERITAGES.map((h) => ({
          ...h,
          pct: (heritagePoints[h.key] / total) * 100 || 0,
        })).sort((a, b) => b.pct - a.pct); // biggest first

        let html = `<h2>Your heritage mix</h2><ul>`;

        // Build list in sorted order
        sortedHeritages.forEach((h) => {
          html += `
    <li style="--heritage-color:${h.color}">
      ${h.label}: ${h.pct.toFixed(1)}%
    </li>`;
        });

        html += `</ul>`;

        summary.innerHTML =
          html +
          `
  <div style="margin-top: 20px; text-align: center;">
    <button id="restart-btn" class="restart-btn">Start Again</button>
  </div>
`;
        // Attach restart functionality
        document.getElementById("restart-btn").onclick = () => {
          playClick(); // optional sound effect (reuses your menu click)
          location.reload(); // ðŸ”„ refreshes the whole page
        };
      }

      /* -------------------------------------------------------------
                       START
     ------------------------------------------------------------- */

      const infoBtn = document.getElementById("info-btn");
      const infoPopup = document.getElementById("info-popup");
      const infoClose = document.getElementById("info-close");

      infoBtn.addEventListener("click", () => {
        infoPopup.classList.add("active");
        playClick();
      });

      infoClose.addEventListener("click", () => {
        infoPopup.classList.remove("active");
        playClick();
      });

      document.getElementById("start-btn").onclick = () => {
        const start = document.getElementById("start-screen");
        const inner = document.getElementById("start-inner");

        playClick();
        // optional: book opening animation if you added it
        inner.classList.add("book-opening");
        setTimeout(() => {
          start.classList.add("hidden");

          setTimeout(() => {
            start.style.display = "none";

            // âœ¨ SHOW NARRATIVE 0 BEFORE MENU
            showPreMenuNarrative();
            startMusic();
          }, 400);
        }, 900); // or 0 if no book animation
      };

      initBar();
    </script>
  </body>
</html>
