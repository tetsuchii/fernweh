<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>fernweh</title>

    <style>
      /* -------------------------------------------------------------
       GLOBAL STYLE — SCRAPBOOK THEME
    ------------------------------------------------------------- */
      @import url("https://fonts.googleapis.com/css2?family=Playwrite+CZ:wght@100..400&display=swap");
      @import url("https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&family=Nunito:ital,wght@0,200..1000;1,200..1000&family=Playwrite+CZ:wght@100..400&display=swap");
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: "Nunito", sans-serif;
      }

      body {
        background: #f7efe7;
        height: 100vh;
        overflow: hidden;
        display: flex;
        justify-content: center;
        align-items: stretch;
      }

      /* ---------------------------------------------------------
   START SCREEN (fullscreen overlay)
--------------------------------------------------------- */

      #start-screen {
        position: fixed;
        inset: 0;
        background: #f7efe7 url("backgrounds/photobook.png") no-repeat;
        background-size: cover;
        background-position: center;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999; /* above everything */
      }

      #start-inner {
        padding: 10px 60px;
        border-radius: 100px;
        text-align: center;
      }

      #start-inner h1 {
        font-size: 5rem;
        color: #956c52;
        margin-bottom: 20px;
        margin-left: 50px;
        font-family: "Playwrite CZ", cursive;
      }

      #start-inner p {
        font-size: 1rem;
        color: #826755;
        width: 400px;
        text-align: center;
        margin-bottom: 10px;
        margin-left: 45px;
      }

      #start-btn {
        font-size: 1.2rem;
        padding: 12px 80px;
        border-radius: 999px;
        margin-left: 45px;
        border: none;
        background: #7f9d86;
        color: #fffaf5;
        cursor: pointer;
        transition: 0.2s;
      }

      #start-btn:hover {
        background: #6f8c77;
        transform: translateY(-2px);
      }

      #floating-words {
        position: absolute;
        inset: 0;
        pointer-events: none;
        overflow: hidden;
        z-index: -1;
      }

      /* ---------------------------------------------------------
   NARRATIVE SCREEN BETWEEN LEVELS
--------------------------------------------------------- */

      #narrative-screen {
        position: fixed;
        inset: 0;
        background: rgba(39, 38, 37, 0.96);
        backdrop-filter: blur(4px);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9998; /* just under start screen, above UI */
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.5s ease;
      }

      #narrative-screen.active {
        opacity: 1;
        pointer-events: auto;
      }

      #narrative-inner {
        padding: 60px 80px;
        border-radius: 22px;
        text-align: center;
      }

      #narrative-text {
        font-size: 1.4rem;
        color: #f2efe3;
        margin-bottom: 40px;
        line-height: 1.5;
      }

      #narrative-btn {
        padding: 12px 30px;
        font-size: 1rem;
        border-radius: 999px;
        border: none;
        background: #946c3b;
        color: #fff;
        cursor: pointer;
        transition: transform 0.15s ease, background 0.15s ease;
      }

      #narrative-btn:hover {
        transform: translateY(-2px);
        background: #7b5235;
      }

      /* ---------------------------------------------------------
   MENU SCREEN (after start screen)
--------------------------------------------------------- */
      #menu-screen {
        position: fixed;
        inset: 0;
        background: #f7efe7 url("backgrounds/photobook-open.png") no-repeat
          center;
        background-size: 130%;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9998;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.5s ease;
      }

      #menu-screen.active {
        opacity: 1;
        pointer-events: auto;
      }

      #menu-inner {
        text-align: center;
        margin-bottom: 40px;
      }

      #menu-inner h2 {
        font-size: 2.6rem;
        color: #956c52;
        margin-bottom: 30px;
        font-family: "Playwrite CZ", cursive;
      }

      #menu-levels {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
        justify-content: center;
        width: 760px;
      }

      .menu-thumb {
        width: 180px;
        height: 120px;
        border-radius: 16px;
        background-size: cover;
        background-position: center;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .menu-thumb:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
        border: #fffaf2 2px solid;
      }

      /* -------------------------------------------------------------
       TREE BACKGROUND LAYER
    ------------------------------------------------------------- */

      #tree-bg {
        position: fixed;
        inset: 0;
        background-size: contain;
        background-position: center;
        background-repeat: no-repeat;
        z-index: 0;
        opacity: 0.9;
        background-size: 1600px auto; /* fixed width */
        background-position: center left;
      }

      /* soft vignette */
      #tree-bg::after {
        content: "";
        position: absolute;
        inset: 0;
        background: radial-gradient(
          circle at center,
          transparent 40%,
          rgba(0, 0, 0, 0.18) 100%
        );
        pointer-events: none;
      }

      /* slight paper texture overlay */
      #paper-grain {
        position: fixed;
        inset: 0;
        background-image: url("backgrounds/paper_texture.png");
        background-size: 600px;
        opacity: 0.25;
        mix-blend-mode: multiply;
        z-index: 1;
        pointer-events: none;
      }

      /* -------------------------------------------------------------
       UI LAYER (HEADER + LEFT PANEL + FOOTER)
    ------------------------------------------------------------- */

      #ui {
        position: relative;
        z-index: 10;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        overflow: hidden; /* prevent weird overflow */
      }

      header {
        background: rgba(255, 255, 255, 0.85);
        padding: 16px 22px;
        border-bottom: 1px solid rgba(120, 95, 80, 0.25);
        backdrop-filter: blur(4px);
      }

      header h1 {
        font-size: 1.5rem;
        color: #6b4e3c;
        font-weight: 700;
      }

      header p {
        font-size: 0.9rem;
        color: #9c7d68;
        margin-top: 3px;
      }

      main {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 12px 18px;

        overflow-y: auto; /* <— THIS makes the UI safe */
        overscroll-behavior: contain;
        min-height: 0; /* required for nested flex scrolling */
      }

      #board {
        flex: 1;
        display: flex;
        gap: 16px;
        min-height: 0;
      }

      /* -------------------------------------------------------------
       LEFT PANEL — DRAGGABLE ITEMS
    ------------------------------------------------------------- */

      #left-panel {
        width: 180px;
        min-width: 150px;
        background: rgba(255, 252, 248, 0.6);
        border-radius: 18px;
        border: #654c3d8d 2px dashed;
        display: flex;
        flex-direction: column;

        overflow-y: auto; /* panel scrolls */
        max-height: 100%; /* never pushes other UI */
      }

      #left-panel-title {
        font-size: 0.8rem;
        font-weight: 600;
        color: #826755;
        margin-bottom: 8px;
        padding-top: 10px;
        text-align: center;
      }

      #panel-toggle {
        width: 100%;
        padding: 12px 15px;
        font-size: 0.8rem;
        background: rgba(255, 255, 255, 0.7);
        border-radius: 10px;
        border-bottom-left-radius: 0px;
        border-bottom-right-radius: 0px;
        border: 0px;
        cursor: pointer;
        margin-bottom: 6px;
        color: #6b4e3c;
        backdrop-filter: blur(4px);
        transition: background 0.15s ease;
        text-align: left;
      }

      #panel-toggle:hover {
        background: rgba(255, 255, 255, 0.9);
      }

      /* PANEL CLOSED STATE */
      /* CLOSED STATE -------------------------------------------------- */

      #left-panel.closed {
        width: 50px !important;
        min-width: 50px !important;

        /* Remove background & border */
        background: transparent !important;
        border: none !important;
        border-radius: 0 !important;

        /* SHRINK TO FIT THE TOGGLE BUTTON */
        height: auto !important;
        max-height: none !important;
        padding: 5 !important;

        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0;
        overflow: visible !important;
      }

      /* Hide draggables + title in closed mode */
      #left-panel.closed #draggables,
      #left-panel.closed #left-panel-title {
        display: none !important;
      }

      /* Toggle button stays visible and centered */
      #left-panel.closed #panel-toggle {
        width: 42px;
        border-radius: 12px;
        margin: 6px auto;
        text-align: center;
        font-size: 0.75rem;
        padding: 6px 4px;
      }

      /* -------------------------------------------------------------
   DRAGGABLE ITEMS — FIXED SIZES
------------------------------------------------------------- */

      #draggables {
        padding: 10px;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(55px, 1fr));
        gap: 7px;
        position: relative;
        z-index: 10; /* Above dropzones */
        pointer-events: auto;
        min-height: 100%;
        flex: 1;
        min-height: 0; /* prevents flex overflow */
        overflow-y: auto;
      }

      .draggable {
        width: 100%;
        cursor: grab;
        transition: transform 0.15s ease, filter 0.15s ease;
        display: flex;
        justify-content: center;
      }

      .draggable img {
        width: 100px; /* small in panel */
        height: fit-content;
        pointer-events: none; /* required! */
        filter: drop-shadow(0 2px 3px rgba(0, 0, 0, 0.25));
      }

      .draggable:hover {
        transform: rotate(-2deg) scale(1.08);
      }

      /* When placed on the board */
      .on-board img {
        width: 90px; /* medium on board */
        height: auto;
        filter: drop-shadow(0 3px 4px rgba(0, 0, 0, 0.2));
      }

      .on-board:hover {
        transform: scale(1.03);
      }

      .level5-zone .draggable img {
        width: 420px !important;
        height: auto !important;
        max-width: 0px;
        max-height: 200px;
        object-fit: contain;
        transition: transform 0.2s ease;
      }

      .level5-zone .draggable:hover img {
        transform: scale(1.05);
      }

      /* When an item is dropped into dzPuppet */
      .in-puppet-zone img {
        width: 420px !important; /* match size of dzPuppet */
        max-width: 100% !important;
        height: auto !important;
        object-fit: contain;
        transition: transform 0.25s ease;
      }

      /* Larger draggables in the panel */
      .panel-large .draggable img {
        width: 120px !important; /* make them bigger */
        height: auto !important;
      }

      /* -------------------------------------------------------------
       DROPZONES
    ------------------------------------------------------------- */

      #dropzones {
        position: fixed;
        inset: 0;
        z-index: 20;
        pointer-events: none;
      }

      .dropzone {
        position: absolute;
        min-width: 60px;
        min-height: 300px;
        /*border: 2px dashed rgba(80, 60, 40, 0.03);*/
        border-radius: 10px;
        background: rgba(255, 250, 245, 0.1);
        pointer-events: auto;
        transition: background 0.15s ease, transform 0.15s ease;
        z-index: 21;
      }

      /* Special horizontal-growing dropzone for Level 1 */
      #dropzones .dropzone.horizontal-grow {
        display: flex;
        flex-direction: row;
        align-items: flex-start;
        min-width: 600px;
        min-height: 370px;
        height: auto;
        padding: 10px;

        width: auto; /* grow horizontally */
        max-width: none;
        white-space: nowrap;

        overflow-x: visible;
        overflow-y: visible;
      }

      .dropzone.dropzone.horizontal-grow .draggable {
        width: auto;
      }

      .dropzone.dropping {
        background: rgba(255, 250, 240, 0.2);
        transform: scale(1.05);
      }

      /* Only Level 2 dropzones align items to bottom */
      .dropzone.bottom-align {
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        align-items: center;
      }

      .level3-zone {
        width: 380px !important;
        height: 20px !important;
        background: rgba(255, 255, 255, 0.15);
        border-radius: 12px;
        display: flex;
        align-items: flex-end;
      }

      /* Make level 3 items bigger when placed on the tree */
      .level3-zone .draggable img {
        max-width: 300px;
        max-height: 300px;
        width: auto;
        height: auto;
        object-fit: contain;
      }

      .level4-zone {
        width: 380px !important;
        min-height: 50px !important;
        max-height: 70px !important;
        border-radius: 12px;
        display: flex;
        align-items: flex-start;
      }

      /* Level 5 dropzones */
      .level5-doll {
        width: 300px !important;
        min-height: 300px !important;
        border-radius: 14px;
      }

      .level5-closet {
        width: 320px !important;
        min-height: 600px !important;
        border-radius: 14px;
      }

      .level6-trigger-zone {
        width: 610px !important;
        height: 540px !important;
        border-radius: 3000px;
      }
      /* -------------------------------------------------------------
       CONTROLS
    ------------------------------------------------------------- */

      #controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: #ffffff;
        padding-top: 8px;
      }

      #next-btn {
        background: #7f9d86;
        color: #fffaf2;
        border: none;
        padding: 9px 18px;
        border-radius: 999px;
        cursor: pointer;
        font-weight: 600;
        box-shadow: 0 4px 10px rgba(60, 85, 70, 0.25);
        transition: transform 0.1s ease, background 0.1s ease;
      }

      #next-btn:hover:not(:disabled) {
        background: #6f8a76;
        transform: translateY(-2px);
      }

      #next-btn:disabled {
        background: #c4b7a9;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
      }

      /* -------------------------------------------------------------
   HERITAGE FOOTER — SCRAPBOOK PASTEL STYLE
------------------------------------------------------------- */

      #heritage-footer {
        background: rgba(255, 250, 245, 0.95);
        padding: 10px 24px;
        border-top: 3px dashed rgba(140, 110, 90, 0.4);
        backdrop-filter: blur(4px);
        box-shadow: 0 -4px 14px rgba(0, 0, 0, 0.12);
      }

      /* WRAPPER */
      #heritage-bar-wrapper {
        width: 100%;
        height: 38px;
        border-radius: 99px;
        overflow: hidden;
        background: #f5e6d6;
        position: relative;
        margin-bottom: 10px;
      }

      /* MAIN BAR */
      #heritage-bar {
        height: 100%;
        display: flex;
        position: relative;
      }

      /* LEGEND */
      #heritage-legend {
        display: flex;
        gap: 10px;
        justify-content: center;
        flex-wrap: wrap;
        margin-top: 5px;
      }

      /* pastel pill legend */
      .heritage-legend-item {
        background: rgba(255, 255, 255, 0.6);
        border: 1px dashed rgba(130, 110, 90, 0.4);
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 0.8rem;
        color: #6b5343;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      /* little color icon */
      .heritage-color-box {
        width: 14px;
        height: 14px;
        border-radius: 4px;
        border: 1px solid rgba(0, 0, 0, 0.25);
      }

      /* -------------------------------------------------------------
       FINAL SUMMARY
    ------------------------------------------------------------- */

      #summary {
        display: none;
        background: rgba(255, 255, 255, 0.9);
        padding: 20px;
        border-radius: 14px;
        margin-top: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        color: #654c3d;
      }

      /* -------------------------------------------------------------
       SAFARI IOS FIXES FOR DRAGGABLES
    ------------------------------------------------------------- */
      @media screen and (-webkit-min-device-pixel-ratio: 0) {
        #draggables {
          min-height: 0;
          min-width: 0;
          align-items: flex-start;
          grid-auto-rows: min-content;
        }

        .draggable {
          align-items: flex-start;
          min-height: 0;
          overflow: hidden;
        }

        .draggable img,
        .on-board img {
          display: block;
          width: 60px;
          height: auto;
          max-width: 100%;
          object-fit: contain;
        }

        .on-board img {
          width: 90px;
        }
      }

      #draggables.panel-large .draggable img {
        width: 140px !important;
      }

      .panel-large .draggable img {
        width: 120px !important;
        height: auto !important;
      }

      #draggables.panel-large {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      }
    </style>
  </head>
  <body>
    <!-- Start screen -->
    <div id="start-screen">
      <div id="start-inner">
        <h1>fernweh</h1>

        <button id="start-btn">Play</button>
        <p><br /><br /><br /><br /></p>
      </div>
    </div>

    <div id="narrative-screen">
      <div id="narrative-inner">
        <p id="narrative-text"></p>
        <button id="narrative-btn">Continue →</button>
      </div>
    </div>

    <div id="menu-screen">
      <div id="menu-inner">
        <h2>Select a Memory</h2>
        <div id="menu-levels"></div>
      </div>
    </div>

    <!-- Background Layers -->
    <div id="tree-bg"></div>
    <div id="paper-grain"></div>

    <!-- UI -->
    <div id="ui">
      <!-- <header>
      <h1>Heritage Mixer</h1>
      <p>Place the memories where they feel at home.</p>
    </header> -->

      <main>
        <section id="board">
          <!-- Left Panel -->
          <div id="left-panel">
            <button id="panel-toggle">Memories</button>
            <div id="draggables"></div>
          </div>
        </section>

        <section id="controls">
          <div id="progress"></div>
          <button id="next-btn" disabled>Lock in →</button>
        </section>

        <section id="summary"></section>
      </main>

      <footer id="heritage-footer">
        <div id="heritage-bar-wrapper">
          <div id="heritage-bar"></div>
        </div>

        <div id="heritage-legend"></div>
      </footer>
    </div>

    <!-- Dropzones Layer -->
    <div id="dropzones"></div>

    <script>
      /* -------------------------------------------------------------
                       JAVASCRIPT (CLEAN, REWRITTEN)
      ------------------------------------------------------------- */

      /* === Heritage Definitions === */
      const HERITAGES = [
        { key: "hungarian", label: "Hungarian", color: "#d78f88" },
        { key: "szekely", label: "Székely", color: "#8aa9c9" },
        { key: "italian", label: "Italian", color: "#91b497" },
        { key: "russian", label: "Russian", color: "#a892c4" },
        { key: "svab", label: "Sváb", color: "#e4c27a" },
      ];

      let heritagePoints = {
        hungarian: 0,
        szekely: 0,
        italian: 0,
        russian: 0,
        svab: 0,
      };

      /* === Levels === */
      const LEVELS = [
        {
          id: 1,
          background: "backgrounds/birth_cert.png",
          maxPerZone: Infinity,
          elements: [
            { id: "anna", image: "assets/anna.png" },
            { id: "nina", image: "assets/nina.png" },
            { id: "toro", image: "assets/toro.png" },
          ],
          dropzones: [{ id: "dzAnna", x: 57, y: 44 }],
        },

        {
          id: 2,
          background: "backgrounds/shelf.png",
          maxPerZone: Infinity,
          elements: [
            { id: "e1", image: "assets/vhs-no.png", heritage: "russian" },
            { id: "e2", image: "assets/vhs-lion.png", heritage: "global" },
            { id: "e3", image: "assets/vhs-szaffi.png", heritage: "hungarian" },
            { id: "e4", image: "assets/vhs-winnie.png", heritage: "global" },
            {
              id: "e5",
              image: "assets/vhs-macskafogo.png",
              heritage: "hungarian",
            },
          ],
          dropzones: [{ id: "vhsZone", xLeft: 18, y: 32 }],
        },

        {
          id: 3,
          background: "backgrounds/christmas_tree.png",
          maxPerZone: 1,
          elements: [
            {
              id: "betlehem",
              image: "assets/betlehem.png",
              heritage: "hungarian",
            },
            {
              id: "dedmoroz",
              image: "assets/dedmoroz.png",
              heritage: "russian",
            },
          ],
          dropzones: [
            { id: "dzBetlehem", x: 30, y: 62 },
            { id: "dzDedmoroz", x: 80, y: 62 },
          ],
        },

        {
          id: 4,
          background: "backgrounds/bar.png",
          maxPerZone: 1,
          elements: [
            { id: "wineBottle", image: "assets/wine.png" },
            {
              id: "glass",
              image: "assets/glass-empty.png",
              allowMultiple: true,
            },
            { id: "soda", image: "assets/soda.png" },
          ],
          dropzones: [
            { id: "dzBottle", x: 30, y: 62 },
            { id: "dzGlass", x: 50, y: 62 },
            { id: "dzSoda", x: 70, y: 62 },
          ],
        },
        {
          id: 5,
          background: "backgrounds/closet.png",
          maxPerZone: 1,
          elements: [
            { id: "hunCloth", image: "assets/hungarian-folkclothing.png" },
            {
              id: "svabCloth",
              image: "assets/svab-folkclothing.png",
            },
          ],
          dropzones: [
            { id: "dzPuppet", x: 34, y: 56 },
            { id: "dzCloset", x: 72, y: 52 },
          ],
        },
        {
          id: 6,
          background: "backgrounds/pizza-on-table.png",
          maxPerZone: 1,
          elements: [
            { id: "knife", image: "assets/knife.png" },
            {
              id: "pizzaCutter",
              image: "assets/pizza-cutter.png",
            },
            { id: "scissor", image: "assets/scissor.png" },
          ],
          dropzones: [{ id: "dzTrigger", x: 59, y: 42 }],
        },
      ];

      /* Narratives between levels */
      const PRE_MENU_TEXT =
        "Every story begins somewhere… before you dive into your memories, open the book and choose where to start.";

      const NARRATIVE = {
        0: "Heritage is the stories we grow up with, shaping how we see the world and ourself in it.",
        1: "Some memories sit next to each other like tapes on an old shelf…",
        2: "Life’s small rituals—like mixing a drink—carry heritage too.",
        3: "Stories change shape depending on where they come from…",
        4: "Music echoes through generations, changing but never disappearing.",
        5: "Homes decorate themselves with memories of the people inside.",
        6: "School days mark us with discipline, laughter, and winter walks.",
        7: "Holidays whisper ancient traditions into the present.",
        8: "Every neighbourhood has its rhythm, its benches, its bakery smell.",
        9: "Markets carry smells that remind you of places you’ve never been.",
        10: "Languages tell the story of where your voice has travelled.",
        11: "Dreams of home mix all your pasts into your future.",
      };

      let currentLevel = 0;
      let placements = {};
      let zoneContents = {};

      /* -------------------------------------------------------------
                       INITIALIZERS
                    ------------------------------------------------------------- */
      function initBar() {
        const bar = document.getElementById("heritage-bar");
        const legend = document.getElementById("heritage-legend");

        bar.innerHTML = "";
        legend.innerHTML = "";

        HERITAGES.forEach((h) => {
          // segment
          const seg = document.createElement("div");
          seg.className = "heritage-segment";
          seg.dataset.key = h.key;
          seg.style.background = h.color;
          seg.style.width = "0%"; // animate from 0
          bar.appendChild(seg);

          // legend pill
          const item = document.createElement("div");
          item.className = "heritage-legend-item";
          item.innerHTML = `
                      <div class="heritage-color-box" style="background:${h.color}"></div>
                      ${h.label}
                    `;
          legend.appendChild(item);
        });

        updateBar();
      }

      function updateBar() {
        const total =
          Object.values(heritagePoints).reduce((a, b) => a + b, 0) || 1;

        HERITAGES.forEach((h) => {
          const seg = document.querySelector(
            `.heritage-segment[data-key="${h.key}"]`
          );
          if (!seg) return;

          const pct = (heritagePoints[h.key] / total) * 100;
          seg.style.width = pct + "%";

          // Do NOT show label if:
          // - it's 100%
          // - or it's the only segment with points
          const isOnlySegmentWithPoints =
            pct === 100 &&
            Object.values(heritagePoints).filter((v) => v > 0).length === 1;

          seg.textContent = "";
        });
      }

      function buildMenu() {
        const wrap = document.getElementById("menu-levels");
        wrap.innerHTML = "";

        LEVELS.forEach((lvl, index) => {
          const thumb = document.createElement("div");
          thumb.className = "menu-thumb";
          thumb.style.backgroundImage = `url(${lvl.background})`;

          thumb.onclick = () => {
            startLevelFromMenu(index);
          };

          wrap.appendChild(thumb);
        });
      }

      function showMenu() {
        buildMenu();
        document.getElementById("menu-screen").classList.add("active");
      }

      function startLevelFromMenu(levelIndex) {
        currentLevel = levelIndex;

        document.getElementById("menu-screen").classList.remove("active");

        // Option A: show narrative before level
        showNarrative(levelIndex);

        // Option B (skip narrative):
        // loadLevel(levelIndex);
      }

      function showPreMenuNarrative() {
        const screen = document.getElementById("narrative-screen");
        const textEl = document.getElementById("narrative-text");

        textEl.textContent = PRE_MENU_TEXT;
        screen.classList.add("active");

        document.getElementById("narrative-btn").onclick = () => {
          screen.classList.remove("active");
          showMenu(); // ✨ then go to the menu
        };
      }

      /* -------------------------------------------------------------
                       LOAD LEVEL
          ------------------------------------------------------------- */

      function loadLevel(i) {
        const level = LEVELS[i];
        placements = {};
        zoneContents = {};

        document.getElementById(
          "tree-bg"
        ).style.backgroundImage = `url(${level.background})`;

        document.getElementById("progress").textContent = `Step ${i + 1}/${
          LEVELS.length
        }`;

        /* Draggables */
        const dwrap = document.getElementById("draggables");
        dwrap.innerHTML = "";

        // Make draggables larger only for levels 1, 4, 5, 6
        const panel = document.getElementById("draggables");
        panel.classList.remove("panel-large"); // reset first

        if ([1, 3, 5, 6].includes(level.id)) {
          panel.classList.add("panel-large");
        }

        level.elements.forEach((el) => {
          const d = document.createElement("div");
          d.className = "draggable";
          d.draggable = true;
          d.dataset.id = el.id;
          d.dataset.heritage = el.heritage;

          const img = document.createElement("img");
          img.src = el.image;

          d.appendChild(img);
          dwrap.appendChild(d);

          d.addEventListener("dragstart", dragStart);
        });

        /* Dropzones */
        const zwrap = document.getElementById("dropzones");
        zwrap.innerHTML = "";

        level.dropzones.forEach((z) => {
          const dz = document.createElement("div");
          dz.className = "dropzone";
          dz.dataset.id = z.id;
          //VHS shelf level
          if (level.id === 2) {
            dz.classList.add("horizontal-grow");
          }

          if (level.id === 3) {
            dz.classList.add("level3-zone");
          }

          if (level.id === 1) {
            dz.classList.add("level4-zone");
          }

          // Level 1 has a left-anchored dropzone (VHS shelf)
          if (level.id === 2 && z.xLeft !== undefined) {
            dz.style.left = z.xLeft + "%";
            dz.style.top = z.y + "%";
            dz.style.transform = "none"; // anchor to left
          } else {
            // default centered behavior for all other levels
            dz.style.left = z.x + "%";
            dz.style.top = z.y + "%";
            dz.style.transform = "translate(-50%, -50%)";
          }

          //BAR level
          if (level.id === 4) {
            dz.classList.add("bottom-align");
          }

          if (level.id === 5) {
            if (z.id === "dzCloset") {
              dz.classList.add("level5-closet"); // bigger dropzone
            }
            if (z.id === "dzPuppet") {
              dz.classList.add("level5-doll"); // smaller dropzone
            }
          }

          if (level.id === 6) {
            if (z.id === "dzTrigger") {
              dz.classList.add("level6-trigger-zone");
            }
          }

          dz.addEventListener("dragover", dragOver);
          dz.addEventListener("dragleave", dragLeave);
          dz.addEventListener("drop", dropItem);

          zwrap.appendChild(dz);
        });

        document.getElementById("next-btn").disabled = true;
      }

      /* -------------------------------------------------------------
   DRAG & DROP (REWRITTEN, UNIFIED SYSTEM)
------------------------------------------------------------- */

      // Move item to the panel
      function moveItemToPanel(itemId, itemEl) {
        const oldZone = placements[itemId];

        // remove from old zone if necessary
        if (oldZone) {
          zoneContents[oldZone] = zoneContents[oldZone].filter(
            (id) => id !== itemId
          );
        }

        placements[itemId] = null;

        const panel = document.getElementById("draggables");
        panel.appendChild(itemEl);
        itemEl.classList.remove("on-board", "in-puppet-zone");
      }

      // Move item to zone (standard case)
      function moveItemToZone(itemId, zoneId, itemEl) {
        // If coming from another zone → remove from it
        if (placements[itemId]) {
          const old = placements[itemId];
          zoneContents[old] = zoneContents[old].filter((i) => i !== itemId);
        }

        // Add to new zone
        placements[itemId] = zoneId;
        zoneContents[zoneId].push(itemId);

        const zoneEl = document.querySelector(`.dropzone[data-id="${zoneId}"]`);
        zoneEl.appendChild(itemEl);
        itemEl.classList.add("on-board");

        // Level 5 puppet size
        if (zoneId === "dzPuppet") itemEl.classList.add("in-puppet-zone");
        else itemEl.classList.remove("in-puppet-zone");

        document.getElementById("next-btn").disabled = false;
      }

      // Swap existing item with dragged item
      function swapItems(existingId, newId, zoneId, newItemEl) {
        const zoneEl = document.querySelector(`.dropzone[data-id="${zoneId}"]`);

        // 1. Find DOM element of existing item
        const existingEl = document.querySelector(
          `.draggable[data-id="${existingId}"]`
        );

        // 2. Move existing item back to its previous place (panel)
        moveItemToPanel(existingId, existingEl);

        // 3. Move new item into the zone
        zoneContents[zoneId] = []; // clear
        moveItemToZone(newId, zoneId, newItemEl);
      }

      let draggedId = null;
      let draggedFromZone = null;

      function dragStart(ev) {
        draggedId = ev.target.dataset.id;

        // Where item currently is:
        draggedFromZone = placements[draggedId] || null;
      }

      function dragOver(ev) {
        ev.preventDefault();
        this.classList.add("dropping");
      }

      function dragLeave() {
        this.classList.remove("dropping");
      }

      function dropItem(ev) {
        ev.preventDefault();
        this.classList.remove("dropping");

        const dzid = this.dataset.id;
        const level = LEVELS[currentLevel];

        const itemEl = document.querySelector(
          `.draggable[data-id="${draggedId}"]`
        );

        // --- STEP 1: If dropped on PANEL, return item to panel ---
        if (!dzid) {
          moveItemToPanel(draggedId, itemEl);
          return;
        }

        // Ensure zone array exists
        if (!zoneContents[dzid]) zoneContents[dzid] = [];

        const zoneMax = level.maxPerZone || Infinity;

        // -------------------------------------------------------
        // STEP 2: If target zone ALLOWS MULTIPLE items
        // -------------------------------------------------------
        if (zoneMax > 1 || level.id === 2) {
          moveItemToZone(draggedId, dzid, itemEl);
          return;
        }

        // -------------------------------------------------------
        // STEP 3: Zone allows ONLY ONE item → SWAP logic
        // -------------------------------------------------------
        if (zoneContents[dzid].length === 1) {
          const existingId = zoneContents[dzid][0];
          swapItems(existingId, draggedId, dzid, itemEl);
          return;
        }

        // -------------------------------------------------------
        // STEP 4: Zone empty → simple move
        // -------------------------------------------------------
        moveItemToZone(draggedId, dzid, itemEl);
      }

      document
        .getElementById("draggables")
        .addEventListener("dragover", (ev) => {
          ev.preventDefault();
        });

      document.getElementById("draggables").addEventListener("drop", (ev) => {
        ev.preventDefault();
        const itemEl = document.querySelector(
          `.draggable[data-id="${draggedId}"]`
        );
        moveItemToPanel(draggedId, itemEl);
      });

      /* ============================================================
                   FROCCS MAKER
                ============================================================ */
      function ejectItem(id, currentZoneId) {
        const itemEl = document.querySelector(`.draggable[data-id="${id}"]`);

        // Where it was before (panel or dropzone)
        const previousZoneId = placements[id];

        // Remove from current dropzone's contents
        zoneContents[currentZoneId] = zoneContents[currentZoneId].filter(
          (x) => x !== id
        );

        // Send back to previous dropzone
        if (previousZoneId && previousZoneId !== currentZoneId) {
          const prevZone = document.querySelector(
            `.dropzone[data-id="${previousZoneId}"]`
          );
          if (prevZone) {
            prevZone.appendChild(itemEl);
            zoneContents[previousZoneId].push(id);
            return;
          }
        }

        // Otherwise send back to panel
        document.getElementById("draggables").appendChild(itemEl);
        placements[id] = null;
      }

      function glassIsInZone(dzid) {
        return zoneContents[dzid] && zoneContents[dzid].includes("glass");
      }

      function handleGlassMovedToZone(dzid) {
        console.log("Glass moved to dropzone:", dzid);
      }

      function applyGlassImageChange(dzid, itemId) {
        const glassImg = document.querySelector(
          `.dropzone[data-id="${dzid}"] .draggable[data-id="glass"] img`
        );
        if (!glassImg) return;

        const src = glassImg.src;
        const hasWine =
          src.includes("glass-wine") || src.includes("glass-froccs");
        const hasSoda =
          src.includes("glass-soda") || src.includes("glass-froccs");

        if (itemId === "wineBottle") {
          if (hasSoda) glassImg.src = "assets/glass-froccs.png";
          else glassImg.src = "assets/glass-wine.png";
        }

        if (itemId === "soda") {
          if (hasWine) glassImg.src = "assets/glass-froccs.png";
          else glassImg.src = "assets/glass-soda.png";
        }
      }

      function getGlassState() {
        const level = LEVELS[currentLevel];
        if (!level) return null;

        // find dropzone containing the glass
        for (const dzid in zoneContents) {
          if (zoneContents[dzid].includes("glass")) {
            const glassImg = document.querySelector(
              `.dropzone[data-id="${dzid}"] .draggable[data-id="glass"] img`
            );
            if (!glassImg) return null;

            if (glassImg.src.includes("glass-froccs")) return "froccs";
            if (glassImg.src.includes("glass-soda")) return "soda";
            if (glassImg.src.includes("glass-wine")) return "wine";
            return "empty";
          }
        }
        return null; // glass never placed
      }

      /* ============================================================
                   RETURN ITEM TO DRAGGABLE PANEL
                ============================================================ */

      const draggablesPanel = document.getElementById("draggables");

      draggablesPanel.addEventListener("dragover", (ev) => {
        ev.preventDefault();
      });

      draggablesPanel.addEventListener("drop", (ev) => {
        ev.preventDefault();
        if (!draggedId) return;

        const el = document.querySelector(`.draggable[data-id="${draggedId}"]`);
        if (!el) return;

        // Remove from dropzone visually
        draggablesPanel.appendChild(el);

        // Remove on-board styling
        el.classList.remove("on-board");

        // Remove from bookkeeping
        const oldZone = placements[draggedId];
        if (oldZone) {
          zoneContents[oldZone] = zoneContents[oldZone].filter(
            (id) => id !== draggedId
          );
        }
        placements[draggedId] = null;

        // Reset button
        document.getElementById("next-btn").disabled = true;
      });

      /* -------------------------------------------------------------
                       SHOW NARRATIVE
                    ------------------------------------------------------------- */

      function showNarrative(nextLevelIndex) {
        console.log("Showing narrative for level", nextLevelIndex);
        const screen = document.getElementById("narrative-screen");
        const textEl = document.getElementById("narrative-text");

        textEl.textContent = NARRATIVE[nextLevelIndex] || "";
        screen.classList.add("active");

        // When player clicks Continue → load next level
        document.getElementById("narrative-btn").onclick = () => {
          screen.classList.remove("active");
          loadLevel(nextLevelIndex);
        };
      }

      /* -------------------------------------------------------------
                       NEXT LEVEL
                    ------------------------------------------------------------- */

      document.getElementById("next-btn").onclick = () => {
        const level = LEVELS[currentLevel];

        // --- apply heritage points ---
        if (level.id === 4) {
          const glassState = getGlassState();

          if (glassState === "froccs") {
            // ONLY FROCCS gives Hungarian heritage
            heritagePoints.hungarian += 7;
          } else {
            // wine-only, soda-only, empty → global
            heritagePoints.russian += 0; // do nothing
          }
          updateBar();
        }

        updateBar();

        // --- advance level --
        console.log(currentLevel);
        currentLevel++;

        // if game is over → finish
        if (currentLevel >= LEVELS.length) {
          finishGame();
          return;
        }

        // --- show narrative (new behaviour) ---
        showNarrative(currentLevel);
      };

      /* -------------------------------------------------------------
                       CLOSE ELEMENT_PANEL
                    ------------------------------------------------------------- */

      const panel = document.getElementById("left-panel");
      const panelToggle = document.getElementById("panel-toggle");

      panelToggle.addEventListener("click", () => {
        const closed = panel.classList.toggle("closed");

        if (closed) {
          panelToggle.textContent = "⮞";
        } else {
          panelToggle.textContent = "⮜  Inventory";
        }
      });

      /* -------------------------------------------------------------
                       END GAME
                    ------------------------------------------------------------- */

      function finishGame() {
        document.getElementById("draggables").innerHTML = "";
        document.getElementById("dropzones").innerHTML = "";
        document.getElementById("next-btn").style.display = "none";

        const summary = document.getElementById("summary");
        summary.style.display = "block";

        let html = `<h2>Your heritage mix</h2><ul>`;
        const total = Object.values(heritagePoints).reduce((a, b) => a + b, 0);

        HERITAGES.forEach((h) => {
          const pct = ((heritagePoints[h.key] / total) * 100).toFixed(1);
          html += `<li>${h.label}: ${pct}%</li>`;
        });

        html += `</ul>`;
        summary.innerHTML = html;
      }

      /* -------------------------------------------------------------
                       START
                    ------------------------------------------------------------- */

      document.getElementById("start-btn").onclick = () => {
        const start = document.getElementById("start-screen");
        const inner = document.getElementById("start-inner");

        // optional: book opening animation if you added it
        inner.classList.add("book-opening");

        setTimeout(() => {
          start.classList.add("hidden");

          setTimeout(() => {
            start.style.display = "none";

            // ✨ SHOW NARRATIVE 0 BEFORE MENU
            showPreMenuNarrative();
          }, 400);
        }, 900); // or 0 if no book animation
      };

      initBar();
    </script>
  </body>
</html>
